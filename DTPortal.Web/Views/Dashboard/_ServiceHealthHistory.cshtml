@model DTPortal.Web.ViewModel.Dashboard.ServiceHealthHistoryViewModel

<style>
    .timeline-label {
        position: relative;
    }

        .timeline-label:before{
            width:0px;
            height:0px;
        }
        .timeline-label .timeline-item-healthy:before {
            height: 100%;
            /*height: 93.5%;*/
            content: "";
            position: absolute;
            left: 106px;
            width: 3px;
            top: 0;
            bottom: 0;
            background-color: green;
        }

        .timeline-label .timeline-item-healthy {
            display: flex;
            align-items: flex-start;
            position: relative;
            /*margin-bottom: 1.3rem;*/
        }

        .timeline-label .timeline-item-unhealthy:before {
            height: 100%;
            /*height: 93.5%;*/
            content: "";
            position: absolute;
            left: 106px;
            width: 3px;
            top: 0;
            bottom: 0;
            background-color: indianred;
        }

        .timeline-label .timeline-item-unhealthy {
            display: flex;
            align-items: flex-start;
            position: relative;
            /*margin-bottom: 1.3rem;*/
        }

        .timeline-label .healthStatus:last-child:before {
            background-color: white !important;
        }


        .timeline-label .timeline-label {
            width: 85px;
            flex-shrink: 0;
            position: relative;
            /* color: #3f4254; */
        }

    .column-left {
        float: left;
        width: 40%;
    }

    .column-right {
        float: right;
        width: 50%;
    }

    .column-center {
        display: inline-block;
        width: 10%;
    }

    .timeline-label.no-data .healthStatus:before,
    .timeline-label.no-data .timeline-item-healthy:before,
    .timeline-label.no-data .timeline-item-unhealthy:before {
        display: none !important;
        content: none !important;
    }

</style>

<div class="modal-dialog" role="document" style="align-content:center">
    <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title w-100 text-center">
                <span class="text-capitalize s3" style="font-size: 17px; align-content:flex-end">
                    @Model.DisplayName <span style="font-size: 14px;">Service Status History</span>
                </span>
            </h5>
            <button type="button"
                    class="close cross btclick"
                    data-dismiss="modal">
                &times;
            </button>
        </div>
        <div class="modal-body">
            <div class="well">
                <div style="display: flex; justify-content: end; margin-right: 5px;">
                    <input id="filterCheckbox" type="checkbox" style="margin-bottom: 6px;margin-right: 5px;">
                    <label for="filterCheckbox">Show Filter</label>
                </div>
                <div id="filterDiv" style="display:none">
                    <div class="form-row">
                        <div class="form-group col-md-4">
                            <input class="form-control datepicker" id="startDate" type="text" style="height:30px" placeholder="Start Date">
                        </div>
                        <span>To</span>
                        <div class="form-group col-md-4" style="margin-left:10px">
                            <input class="form-control datepicker" id="endDate" type="text" style="height:30px" placeholder="End Date">
                        </div>
                        <button id="applyFilterBtn" type="button" class="btn btn-primary" onclick="filterHistory('@Model.ServiceName');" style="height:30px; margin-right: 5px;" disabled>Apply</button>
                        <button type="button" class="btn btn-danger" onclick="resetFields()" style="height:30px">Clear</button>
                    </div>
                </div>
                <div id="project-timeline-container" class="ps" style="height:350px">
                    <div id="spin">
                        <div class="cv-spinner">
                            <span class="spinner">

                            </span>
                        </div>
                    </div>
                    <div id="filteredServiceHealthHistoryDiv" class="card-body pt-5">
                        @await Html.PartialAsync("_FilteredServiceHealthHistory", Model.ServiceHealthHistory)
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary btclick" data-dismiss="modal">Close</button>
        </div>
    </div>
</div>

<script>

      $( "#startDate" ).on("change", stateHandle );
      $( "#endDate" ).on("change", stateHandle );
      $( "#filterCheckbox" ).on("change", toggleFilter );
      var button = $("#applyFilterBtn");
      button.prop('disabled', true);

      //var today = new Date();
      //$('.datepicker').datepicker({
      //    dateFormat: "yy-mm-dd",
      //    changeMonth: true,
      //    changeYear: true,
      //    maxDate: new Date(today.getFullYear(), today.getMonth(), today.getDate())
      //});
    var today = new Date();
    $("#startDate").datepicker({
        dateFormat: "yy-mm-dd",
        defaultDate: "+1w",
        changeMonth: true,
        numberOfMonths: 1,
        maxDate: new Date(today.getFullYear(), today.getMonth(), today.getDate()),
        onClose: function (selectedDate) {
            $("#endDate").datepicker("option", "minDate", selectedDate);
        }
    });

    $("#endDate").datepicker({
        dateFormat: "yy-mm-dd",
        defaultDate: "+1w",
        changeMonth: true,
        numberOfMonths: 1,
        maxDate: new Date(today.getFullYear(), today.getMonth(), today.getDate()),
        onClose: function (selectedDate) {
            $("#startDate").datepicker("option", "maxDate", selectedDate);
        }
    });

      $('.btclick').on("click",function(){
          $('Table#ServiceHealth tbody tr').attr("data-toggle", "collapse");
      });

      function toggleFilter()
      {
          var isChecked = this.checked;
          $("#filterDiv").toggle(isChecked);
          if (isChecked == false)
          {
             resetFields();
             filter('@Model.ServiceName', '', '');
          }
      }

      function filterHistory(serviceName)
      {
          var startDate = $('#startDate').val() + ' 00:00:00';
          var endDate = $('#endDate').val() + ' 23:59:59';
          filter(serviceName, startDate, endDate);
      }

      function filter(serviceName, startDate, endDate)
      {
          $('#filteredServiceHealthHistoryDiv').empty();
          var url = '@Url.Action("GetFilteredServiceHealthHistory", "Dashboard")?serviceName='+serviceName+'&startDate='+startDate+'&endDate='+endDate;
          $.ajax({
                  type: "GET",
                  url: url,
                  contentType: "application/json; charset=utf-8",
                  datatype: "json",
                  beforeSend: function () {
                      $('#spin').show();
                  },
                  complete: function () {
                      $('#spin').hide();
                  },
                  success: function (data) {
                      if (data != null)
                      {
                          $('#filteredServiceHealthHistoryDiv').html(data);
                      }
                      else
                      {
                          swal({ type: 'error', title: "Error", text: "Failed to get service history" });
                      }
                  },
                  error: ajaxErrorHandler,
                  failure: function (response) {
                      swal({ type: 'error', title: "Error", text: "Failed to process your request" });
                  }
              });
      }

      function stateHandle() {
          if($("#startDate").val() === "" || $("#endDate").val() === "") {
              button.prop('disabled', true);
          } else {
              button.prop('disabled', false);
          }
      }

      function resetFields() {
              button.prop('disabled', true);
              $("#startDate").val('');
              $("#endDate").val('');
        filter('@Model.ServiceName', '', '');
          }
</script>




