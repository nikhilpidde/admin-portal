@model DTPortal.Web.ViewModel.ESealRegistration.StakeholderViewModel
@inject Microsoft.Extensions.Configuration.IConfiguration Configuration
@{
    var clientName = @Configuration["ProjectName"] as string;
}
<style>
    .modal-dialog {
        max-width: 900px;
    }

    .cross {
        color: black;
        padding: 5px;
        margin: 10px;
    }

    .custom-file-upload {
        background: #f7f7f7;
        padding: 3px 10px;
        border: 1px solid #e3e3e3;
        border-radius: 5px;
        border: 1px solid #ccc;
        display: inline-block;
        cursor: pointer;
    }

    #popupOverlay {
        position: fixed;
        top: 0;
        z-index: 10000;
        width: 100%;
        height: 100%;
        display: none;
        background: rgba(0, 0, 0, 0.6);
    }

    /*.loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 50px;
      height: 50px;
          margin: auto;
      animation: spin 2s linear infinite;
    }*/

    .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        margin: auto;
        display: flex;
        justify-content: center;
        align-items: center;
        animation: spin 2s linear infinite;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }


    @@keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }
</style>
<div id="addStakeHolder_CSV">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div id="popupOverlay">
                <div class="loader"></div>
            </div>
            <div class="modal-header">
                <h5 class="modal-title s3">
                    <span class="text-capitalize s3" style="font-size: 18px">
                        Add Stakeholder
                    </span>
                </h5>
                <button type="button"
                        class="close cross"
                        data-dismiss="modal">
                    &times;
                </button>
            </div>
            <div class="modal-body">

                <div class="row">
                    <div class="col-md-12">
                        <div class="card" style="height: 70px;z-index:1;">
                            <div class="form-row" style="margin-top: 4px;">
                                <div class="form-group col-md-5">
                                   <div class="custom-file" style="width:92%">
                                        <input type="file" id="uploadStakeHolderCSV" class="form-control custom-file-upload" accept=".csv">
                                        <label for="uploadStakeHolderCSV" class="custom-file-label">Choose File...</label>
                                        <span id="trustedStakeholderDtosList" class="text-danger"></span>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="btn-group">
                                        <a class="btn btn-info" href="@Url.Action("DownloadCSV", "ESealRegistration")">Download Template</a>
                                    </div>
                                    &nbsp;&nbsp;
                                    @*<div class="btn-group">
                                    <a class="btn btn-info" asp-action="Search" asp-controller="ControlledOnboarding"></i>Search</a>
                                    </div>*@
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="stakeholderCsvData">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card-custom">
                                <div class="card-body">
                                    <table id="userList" class="table table-striped table-bordered" cellspacing="0" width="100%">
                                        <thead>
                                            <tr>
                                                <th width="33.33%">Name</th>
                                                <th width="33.33%">SPOC @clientName Email</th>
                                                <th width="33.33%">Stakeholder Type</th>
                                            </tr>
                                        </thead>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="submitFile()" data-submit="modal">Save</button>
                <button class="btn btn-secondary" id="redirectToStakeholderList" >Close</button>
            </div>
        </div>
    </div>
</div>

<script>
    var table;
    var allowedCSVFileTypes = ['.csv'];
    var emailRegex = /^([\w-\.]+)@@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.)|(([\w-]+\.)+))([a-zA-Z]{2,4}|[0-9]{1,3})(\]?)$/;

    $(document).ajaxSend(function (event, xhr, options) {

        $('#popupOverlay').show();

    }).ajaxComplete(function (event, xhr, options) {

        $('#popupOverlay').hide();

    }).ajaxError(function (event, jqxhr, settings, exception) {

        $('#popupOverlay').hide();

    });


    $(document).ready(function () {
       

        table = $('#userList').DataTable();

        $("#stakeholderCsvData").hide();

        var previousFile = null;

        $(document).on("change", '#uploadStakeHolderCSV', function () {
            var file = $(this).get(0).files[0];
            var fileName = file ? file.name : "Choose File...";

            // Check if the new file is the same as the previous file
            if (file && previousFile && file.name === previousFile.name && file.size === previousFile.size) {
                
                resetFileInput(this); // Reset the file input
                return;
            }

            previousFile = file; // Update the previousFile variable with the new file

           
            resetAndClearData();

            if (file == undefined) {
                fileName = "Choose File...";
            }
            else {
                fileName = file.name;
                var fileExtension = getExtension(file.name);
                if (allowedCSVFileTypes.includes(fileExtension)) {
                    var reader = new FileReader();

                    reader.onload = function (e) {
                        $("#stakeholderCsvData").show();
                        var name;
                        var spocUgpassEmail;
                        var stakeholderType;
                        var validData = true;

                        var rows = e.target.result.split("\n");

                        for (var i = 1; i < rows.length; i++) {
                            var cells = rows[i].replace("\r", "").split(",");

                            if (cells.length == 3) {
                                name = cells[0];
                                spocUgpassEmail = cells[1];
                                stakeholderType = cells[2];
                                if (spocUgpassEmail == "" || !emailRegex.test(spocUgpassEmail)) {
                                    validData = false;
                                    break;
                                }

                                if (name == "") {
                                    validData = false;
                                    break;
                                }
                                if (validData) {
                                    table.row.add(cells).draw();
                                }
                            }
                        }

                        if (!validData) {
                            resetAndClearData();
                            
                            fileName = "Choose File...";
                            $('.custom-file-label').html(fileName);
                            if (spocUgpassEmail == "" || !emailRegex.test(spocUgpassEmail)) {
                                swal({ type: 'error', title: "Invalid Email", text: spocUgpassEmail + " is an invalid email." });
                            }
                            else if (name == "") {
                                swal({ type: 'error', title: "Invalid Name", text: "Name cannot be null." });
                            }
                            $('#uploadStakeHolderCSV').val('');
                        }
                    };
                    reader.readAsText(file);
                }
                else {
                    swal({ type: 'error', title: "File Not Supported", text: "Files with extensions: " + allowedCSVFileTypes.join(',') + " are only supported." });
                }
            }

            $(this).next('.custom-file-label').html(fileName);
        });

        // Function to reset the file input element
        function resetFileInput(input) {
            if (input) {
                try {
                    // Clear the file input by cloning and replacing it
                    input.value = ''; // The input is read-only, so clear its value
                    var clone = input.cloneNode(true);
                    input.parentNode.replaceChild(clone, input);
                    previousFile = null; // Reset the previousFile variable
                } catch (error) {
                    console.error('Error resetting file input:', error);
                }
            }
        }

        function resetAndClearData() {
            table.clear().draw();
            $("#stakeholderCsvData").hide();
            $('#uploadStakeHolderCSV').val('');
        }
    });

   

    function submitFile() {
       
        $('#userList').DataTable().rows().iterator('row', function (context, index) {
            var node = $(this.row(index).node());
        });

        var trustedUserList = tableData();
        
        if (trustedUserList.length == 0) {
            swal({ type: 'error', title: "Failed", text: "Please upload file" });
        }
        else {
            $.ajax({
                url: '@Url.Action("AddStakeHolder", "ESealRegistration")',
                data: JSON.stringify(trustedUserList),
                type: "POST",
                // contentType: "json",
                contentType: "application/json",
                error: ajaxErrorHandler,
                beforeSend: function () {
                    $('#overlay').show();
                },
                complete: function () {
                    $('#overlay').hide();
                },
                success: function (data) {
                    if (data != null) {
                        if (data.status == "Success") {
                            swal({ type: 'success', title: "Success", text: data.message }, function (isConfirm) {
                                registeredStakeHolders(stakeHolderOrgUID.referedById)
                            });
                        }
                        else {
                            swal({ type: 'error', title: "Failed", text: data.message }, function (isConfirm) {
                                $('#viewStakeholderForm').trigger('click');
                            });
                        }
                    }
                    else {
                        swal({ type: 'error', title: "Failed", text: "Failed to add trusted users" }, function (isConfirm) {
                            $('#viewStakeholderForm').trigger('click');
                        });
                    }
                }
            });
        }


    }

    function tableData() {
        
        var list = [];
        var data = $('#userList').DataTable().rows().data();

        for (var i = 0; i < data.length; i++) {
            var stakeholders = 
                {
                    name: data[i][0],
                    spocUgpassEmail: data[i][1],
                    stakeholderType: data[i][2],
                   
                }
           
            list.push(stakeholders);
        }
        return list;
    }

    function getExtension(filename) {
       
        return '.' + filename.split('.').pop().toLowerCase();
    }

   
</script>
