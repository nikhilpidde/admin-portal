@model DTPortal.Web.ViewModel.OrganizationPaymentHistory.AddOrganizationPaymentHistoryViewModel
@using DTPortal.Web.Enums

<div class="row">
    <div class="col-md-12">
        <div class="card-custom">
            <div class=card-body>
                <form asp-action="Add" method="post">
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <input asp-for="OrganizationId" class="form-control" hidden />
                            <div class="form-group col-md-12">
                                <label asp-for="OrganizationName" class="col-form-label"></label>
                                <input asp-for="OrganizationName" class="form-control" />
                                <span asp-validation-for="OrganizationName" class="text-danger"></span>
                            </div>
                            <div class="form-group col-md-12">
                                <label asp-for="TransactionReferenceId" class="col-form-label"></label>
                                <input asp-for="TransactionReferenceId" class="form-control" />
                                <span asp-validation-for="TransactionReferenceId" class="text-danger"></span>
                            </div>
                            <div class="form-group col-md-12">
                                <label asp-for="TotalAmountPaid" class="col-form-label"></label>
                                <input asp-for="TotalAmountPaid" class="form-control" />
                                <span asp-validation-for="TotalAmountPaid" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="form-group col-md-6">
                            <div class="form-group col-md-12">
                                <label asp-for="PaymentChannel" class="col-form-label"></label>
                                <select asp-for="PaymentChannel" asp-items="Html.GetEnumSelectList<PaymentChannel>()" class="form-control">
                                    <option value="">select</option>
                                </select>
                                <span asp-validation-for="PaymentChannel" class="text-danger"></span>
                            </div>
                            @*<div class="form-group col-md-12">
                                <label asp-for="PaymentInfo" class="col-form-label"></label>
                                <input asp-for="PaymentInfo" class="form-control" />
                                <span asp-validation-for="PaymentInfo" class="text-danger"></span>
                                </div>*@
                            <div class="form-group col-md-12">
                                <label asp-for="InvoiceNumber" class="col-form-label"></label>
                                <input asp-for="InvoiceNumber" class="form-control" />
                                <span asp-validation-for="InvoiceNumber" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                    <div>
                        <div class="d-flex justify-content-end " style="padding-top: 31px;">
                            <button type="submit" id="submitBtn" class="btn btn-primary">Save</button>
                            &nbsp;&nbsp;
                            <a type="button" asp-action="OrganizationPaymentHistory" class="btn btn-danger">
                                Cancel
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="~/lib/jquery-validation/dist/jquery.validate.min.js" asp-append-version="true"></script>
<script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js" asp-append-version="true"></script>
<script src="~/lib/jquery-ajax-unobtrusive/jquery.unobtrusive-ajax.min.js" asp-append-version="true"></script>

<script>
    var innerDictionary = {};
        $(document).ready(function ()
    {


       $('input[type=text]:not([readonly]),input[type=number]:not([readonly]),input[type=email]:not([readonly]),input[type=file]:not([readonly]),select:not([readonly])').each(function ()
         {
            var req = $(this).attr('data-val-required');
            var exclude = $(this).attr('data-exclude');
            if (undefined != req && undefined == exclude)
            {
                var label = $('label[for="' + $(this).attr('id') + '"]');
                var text = label.text();
                if (text.length > 0) {
                    label.append(' <span style="color:#ff0000b3;">*</span>');
                }
            }
        });

        $("#submitBtn").click(function (e) {
            e.preventDefault();
            if (!formValidation())
            {
                return false;
            }
            else{
                var model = new FormData($('Form').get(0));

                                            $.ajax({
                                                type: "POST",
                                                url: '@Url.Action("Add", "OrganizationPaymentHistory")',
                                                headers: {
                                                    "XSRF-TOKEN": $('input[name="__RequestVerificationToken"]').val()
                                                },
                                                data: model,
                                                processData: false,
                                                contentType: false,
                                                error: ajaxErrorHandler,
                                                success: function (data) {
                                                    if (data.status == "Success") {
                                                        swal({
                                                            type: 'success', title: "Success", text: data.message
                                                        }, function (isConfirm) {
                                                            if (isConfirm) {
                                                                window.location.href = '@Url.Action("OrganizationPaymentHistory", "OrganizationPaymentHistory")'
                                                            }
                                                        });
                                                    }
                                                    if (data.status == "Failed") {
                                                        swal({ type: 'error', title: "Error", text: data.message });
                                                    }
                                                }
                                            });
            }
        });
    });

     $("#OrganizationName").typeahead({
        minLength: 2,
                items: 10,
                source: function (request, response) {
                    $.ajax({
                        url: '@Url.Action("GetOrganizations", "OrganizationPaymentHistory")',
                        data: {"value": request },
                        type: "GET",
                        contentType: "json",
                        error: ajaxErrorHandler,
                       success: function (data) {
                            items = [];
                            map = {};
                            innerDictionary = {};
                            $('#OrganizationId').val('');
                            $.each(data, function (i, item) {
                                var id = i;
                                var array = item.split(",");
                                var uid = array[1];
                                var name = array[0];
                                map[name] = {
                                    id: id,
                                    name: name
                                };
                                items.push(name);
                                innerDictionary[name] = uid;
                            });
                            response(items);
                        }
                    });
                },
                 updater: function (item) {
                     $('#OrganizationId').val(innerDictionary[item]);
                   return item;
            }
    });
</script>