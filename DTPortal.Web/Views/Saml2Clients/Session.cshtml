@model DTPortal.Web.ViewModel.Saml2Clients.Saml2ClientsSessionListViewModel

@{ ViewData["Title"] = "Saml2 Sessions"; }


@{await Html.RenderPartialAsync("_AlertBox");}

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body ">
                <div class="row p-b-20">
                    <div class="col-md-6 col-sm-6 col-6">
                        <div class="btn-group">
                            <a href="" class="btn btn-info" id="deletAll" style='@(Model.session == null || Model.session.Count() == 0? "pointer-events: none;color: #ccc;":"")'>
                                Logout All Session
                            </a>

                        </div>
                    </div>

                </div>
                <table id="sessionTable" class="table table-striped table-bordered table-hover table-checkable order-column full-width">
                    <thead>
                        <tr>
                            <th>User ID</th>
                            <th>Name</th>
                            <th>IP Address</th>
                            <th>Started</th>
                            <th>Last Access</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.session == null || Model.session.Count() == 0)
                        {
                           <tr>
                                <td style="text-align:center" valign="top" colspan="6" class="dataTables_empty">No record found</td>
                           </tr>

                        }
                        else
                        {
                            @foreach (var item in Model.session)
                            {
                                <tr class="odd gradeX">
                                    <td>@item.UserId</td>
                                     <td>@item.FullName</td>
                                    <td>@item.IpAddress</td>
                                    <td>@item.LoggedInTime</td>
                                    <td>@item.LastAccessTime</td>
                                    <td class="valigntop">
                                        <div class="btn-group">
                                            <a class="btn btn-primary js-delete" data-id="@item.GlobalSessionId"><i class="fa fa-trash"></i>Logout</a>
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section scripts{

    <script>
        var table = "";
        $(document).ready(function () {

            $('#digitalAuthSidebarElement').addClass('active');
            $('#OauthSamlSidebarElement').addClass('active');
            $('#OauthOpenIDSidebarElement').addClass('active');

            $('#homeSubmenu').addClass('show');
            $('#OauthSamlSubmenu').addClass('show');

            $("li#digitalAuthSidebarElement a:first").attr('aria-expanded', 'true');
            $("li#OauthSamlSidebarElement a:first").attr('aria-expanded', 'true');

            /*For Beadcrum Start*/
            $('#homeMenu').addClass('breadcrumb-item').append('Digital Authentication');
            $('#mainMenu').addClass('breadcrumb-item active').append('Service Providers > OAuth2/OpenID > '+'@Model.ClientName');
            $('#subMenu').removeClass('breadcrumb-item');
            // table = $("#sessionTable").DataTable({
            //    "bLengthChange": false,

            //    "searching": false,
            //    "select": {
            //        style: 'multi',
            //        info: true
            //    },
            //    "dom": 'fBrtip',
            //    "buttons": [
            //        'selectAll',
            //        'selectNone',
            //    ]
            //});

            $('#sessionTable').on('click', '.js-delete', function () {
                var deleteButton = $(this);
                var id = deleteButton.attr("data-id");

                swal({
                    title: "Are you sure!",
                    text: "you want to logout user with " + id + "  sessionID",
                    type: "info",
                    showCancelButton: true,
                    confirmButtonColor: "#DD6B55",
                    confirmButtonText: "Yes",
                    cancelButtonText: "No",
                    closeOnConfirm: false,
                    closeOnCancel: true
                }, function (isConfirm) {
                    if (isConfirm) {
                        $.ajax({
                            type: 'POST',
                            cache: false,
                            dataType: 'json',
                            url: '@Url.Action("Logout", "Clients")',
                            data: {
                                id: id
                            },
                            beforeSend: function () {
                                $('#overlay').show();
                            },
                            complete: function () {
                                $('#overlay').hide();
                            },
                            success: function (result, status, xhr) {
                                var title, text, type = "";
                                if (result.success) {
                                    title = "Success!";
                                    type = "success";
                                    text = "Logout successful"
                                }
                                else {
                                    title = "Error!";
                                    type = "error";
                                    text = result.message
                                }
                                swal(title, text, type);
                                $("#sessionTable").DataTable().row(deleteButton.parents("tr")).remove().draw();
                            },
                            error:ajaxErrorHandler
                        });
                    } else {
                        return false
                    }
                });
            });

            $("#deletAll").on("click", function (e) {
                var data = table.rows({ selected: true }).data().toArray();
                if (data.length == 0) {
                    swal("Message", "No record(s) selected", "info");
                } else {
                    e.preventDefault();
                    swal({
                        title: "Are you sure?",
                        text: `You are about to delete ${data.length} record(s)!`,
                        type: "warning",
                        showCancelButton: true,
                        confirmButtonColor: "#DD6B55",
                        confirmButtonText: "Yes",
                        cancelButtonText: "No",
                        closeOnConfirm: false,
                        closeOnCancel: false
                    }, function (isConfirm) {
                            if (isConfirm) {
                                var rows = [];
                                for (var i = 0; i < data.length; i++){
                                    rows.push(data[i][3]);
                                }
                                fn_custom_delete(rows);

                        } else {
                            swal("Abort", "Operation aborted :)", "error");
                            deselectAllRecords()
                        }
                    });

                }
                return false;
            });
        });


        function fn_custom_delete(data) {
            try {
                if (data.length) {
                    $.ajax(
                        {
                            type: 'POST',
                            url: '@Url.Action("LogoutAll", "Clients")',
                           // contentType: 'application/json',
                            //dataType: 'json',
                            //traditional: true,
                            data: {
                                id: data
                            },
                            beforeSend: function (xhr, opts) {
                                swal("Processing", "Please wait while we are deleting records", "info")
                            },
                            success: function (result, status, xhr) {
                                var title, text, type = "";
                                if (result.success) {
                                    title = "Success!";
                                    type = "success";
                                    text = "Logout successful"
                                }
                                else {
                                    title = "Error!";
                                    type = "error";
                                    text = result.message
                                }
                                swal(title, text, type);
                                window.location.reload();
                            },
                            error:ajaxErrorHandler
                        }
                    )
                } else {
                    throw "No roles provided to delete"
                }
            } catch (error) {
                alert(error)
            }
        }

    </script>
}
