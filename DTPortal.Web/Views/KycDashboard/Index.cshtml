@model DTPortal.Web.ViewModel.KycDashboard.IdValidationDashboardModal
@inject Microsoft.Extensions.Configuration.IConfiguration Configuration

@{
    var kafkaUrl = Configuration["SignalR:KafkaLogHubUrl"];
}

@{
    ViewData["Title"] = "Dashboard";
}

@{
    await Html.RenderPartialAsync("_AlertBox");
}

<script src="~/assets/js/chart.js"></script>

@{
    var totalDevices = Model.KycSummary?.TotalKycDevices.ToString() ?? "0";
    // var totalDevices ="201";
}

<style>
    .dashboard-header {
        padding: 2rem 0 1rem 0;
        background: #fff;
        border-bottom: 1px solid #e1e5ee;
        margin-bottom: 2rem;
    }

    .dashboard-title {
        font-weight: 700;
        color: #22223b;
    }

    .nav-pills .nav-link {
        font-weight: 500;
        font-size: 1.1rem;
        padding: 0.75rem 2rem;
        border-radius: 2rem;
        margin-right: 1rem;
        transition: background 0.2s, color 0.2s;
    }

        .nav-pills .nav-link.active {
            background: linear-gradient(90deg, #1976d2 0%, #00bcd4 100%);
            color: #fff;
            box-shadow: 0 2px 8px rgba(25, 118, 210, 0.08);
        }

    .tab-pane {
        animation: fadeIn 0.4s;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(16px);
        }

        to {
            opacity: 1;
            transform: none;
        }
    }

    .kpi-card {
        border-radius: 1rem;
        box-shadow: 0 2px 8px rgb(31 25 25 / 23%);
        padding: 1.5rem 1rem;
        background: #fff;
        text-align: center;
    }

    .kpi-label {
        color: #6c757d;
        font-size: 1.1rem;
    }

    .kpi-value {
        font-size: 2.1rem;
        font-weight: 600;
    }

    .status-badge {
        padding: 0.35em 0.9em;
        border-radius: 12px;
        font-size: 0.95em;
        color: #fff;
    }

    .status-success {
        background: #28a745;
    }

    .status-pending {
        background: #ffc107;
        color: #22223b;
    }

    .status-failure {
        background: #dc3545;
    }

    .status-blacklisted {
        background: #343a40;
    }

    .risk-low {
        color: #28a745;
    }

    .risk-medium {
        color: #ffc107;
    }

    .risk-high {
        color: #dc3545;
    }

    .table-responsive {
        margin-top: 1rem;
    }

    .chart-responsive {
        width: 100%;
        aspect-ratio: 2/1;
        min-height: 200px;
        margin-bottom: 2rem;
    }

    .list-group {
        position: absolute;
        z-index: 10;
        width: 100%;
    }

    @@media (max-width: 767.98px) {
        .dashboard-header {
            padding: 1.2rem 0 0.5rem 0;
        }

        .kpi-card {
            margin-bottom: 1rem;
        }

        .chart-responsive {
            aspect-ratio: 1/1;
            min-height: 180px;
        }

        .nav-pills .nav-link {
            padding: 0.75rem 1rem;
        }
    }

    canvas {
        width: 100% !important;
        height: 100% !important;
        display: block;
    }
    .shimmer-wrapper .shimmer-item {
        height: 90px;
        margin-top: 10px;
        margin-bottom: 10px;
        border-radius: 8px;
        background: #f3f3f3;
        position: relative;
        overflow: hidden;
    }

    @@media screen and (max-width:1200px) {
        .shimmer-wrapper .shimmer-item {
            height: 150px;
        }
    }

    /* Shimmer band */
    .shimmer-wrapper .shimmer-item::after {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient( to right, rgba(255, 255, 255, 0) 0%, rgba(255, 255, 255, 0.6) 50%, rgba(255, 255, 255, 0) 100% );
        animation: shimmer-horizontal 1.6s ease-in-out infinite;
        pointer-events: none;
    }



    @@keyframes shimmer-horizontal {
        0% {
            left: -100%;
        }

        100% {
            left: 100%;
        }
    }

    .service-provider-card {
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 1rem;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        color: #212529;
        border: 1px solid #dee2e6 !important;
        cursor: pointer;
    }

        .service-provider-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
        }

    /* Backgrounds by status */
    .status-active {
        background-color: #e8f5e9 !important;
    }

    .status-inactive {
        background-color: #f8d7da !important;
    }

    .status-registered {
        background-color: #fff3cd !important;
    }

    /* Status badge */
    .status-badge {
        padding: 6px 14px;
        border-radius: 50px;
        font-weight: 600;
        font-size: 0.85rem;
        min-width: 100px;
        text-align: center;
        box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        text-transform: capitalize;
    }

    .status-badge-active {
        background-color: #28a745;
        color: #fff;
    }

    .status-badge-inactive {
        background-color: #dc3545;
        color: #fff;
    }

    .status-badge-registered {
        background-color: #ffc107;
        color: #000;
    }

    .sp-label-heading {
        font-family: 'Arial', sans-serif;
        font-size: 12px;
        font-weight: 600;
        color: #6c757d;
        margin-bottom: 5px;
    }

    .custom-modal-body {
        max-height: 400px;
        overflow-y: auto;
        overflow-x: hidden;
        padding: 1rem;
        word-break: break-word;
    }

    .signed-response-content {
        white-space: pre-wrap;
        font-family: monospace;
        font-size: 14px;
        border-radius: 6px;
        margin-top: 10px;
        color: #333;
    }


    .custom-modal-width {
        max-width: 700px; /* Adjust as needed, e.g., 500px, 600px */
        width: 90%; /* Optional: Responsive width */
    }

    .modal-header {
        background-color: #f0f0f0;
        border-bottom: 1px solid #ddd;
    }

    .modal-title {
        font-weight: 600;
        font-size: 18px;
        color: #333;
    }

    .total-devices {
        display: flex;
        align-items: center;
        flex-wrap: wrap; /* allows wrapping on small screens */
    }

    .total-label {
        font-weight:600;
        font-size: 1.2rem;
        margin: 0;
        margin-right: 12px;
    }

    .device-count-cards {
        display: flex;
        gap: 8px;
    }

    .digit-card {
        background-color: white;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        padding: 4px 6px;
        font-size: 1.3rem;
        font-weight: 600;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        color: #333;
        min-width: 40px;
        text-align: center;
        
    }


    .response-tabs-wrapper .nav-link {
        border-radius: 22px;
        border: 1px solid transparent;
        padding: 6px 16px;
        transition: 0.3s;
    }

        .response-tabs-wrapper .nav-link:not(.active) {
            border: 1px solid #ccc;
            background-color: #f8f9fa;
            color: #495057;
        }

        .response-tabs-wrapper .nav-link.active {
            background-color: #0d6efd;
            color: #fff;
            border-color: #0d6efd;
        }

</style>
<style>
    .verified-response-content {
        overflow-x: hidden;
        padding-right: 5px;
    }

        .verified-response-content strong {
            min-width: 140px;
            display: inline-block;
            color: #333;
        }

        .verified-response-content div {
            word-break: break-word;
        }

        .verified-response-content img {
            display: block;
            margin-top: 5px;
        }

    .me-3 {
        margin-right: 1rem !important; /* Bootstrap 5 spacing */
    }
</style>
<link rel="stylesheet" href="~/assets/css/font-awesome-6.4.2/css/all.min.css" />

@{
    var successful = Model.KycSummary?.TotalSuccessfulKycs ?? 0;
    var failed = Model.KycSummary?.TotalFailedKycs ?? 0;
    var successRate = (successful + failed) > 0
        ? (successful * 100.0) / (successful + failed)
        : 0;
}


<div class="dashboard-header container-fluid">
    <div class="container">
        <div class="d-flex flex-column flex-md-row">
            <div>
                <h3 class="dashboard-title mb-0">ID Validation Dashboard</h3>
            </div>
        </div>
    </div>

    <br />

    <div class="container">

        <!-- Enhanced Tabs -->
        <ul class="nav nav-pills mb-4" id="kycTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="overall-tab" type="button" role="tab" style="font-size:1.0rem">
                    <i class="fa fa-chart-bar me-2"></i>Overall Stats
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="org-tab" type="button" role="tab" style="font-size:1.0rem">
                    <i class="fa fa-building me-2"></i>Service Providers
                </button>
            </li>
        </ul>

        <div class="tab-content" id="kycTabContent">
            <!-- Overall Stats Tab -->
            <div class="tab-pane" id="overall" role="tabpanel">
                <!-- KPI Cards -->
                <div class="row g-3 mb-4">
                    <!-- First row -->
                    <div class="col-12 col-md-4">
                        <div class="kpi-card">
                            <div class="kpi-label" style="font-weight:600">Total Service Providers</div>
                            <div id="totalServiceProviders" class="kpi-value">@Model.KycSummary?.TotalServiceProviders</div>
                        </div>
                    </div>
                    <div class="col-12 col-md-4">
                        <div class="kpi-card">
                            <div class="kpi-label" style="font-weight:600">Total IDs Verified</div>
                            <div id="totalSuccessfulKycs" class="kpi-value text-success">@Model.KycSummary?.TotalSuccessfulKycs</div>
                        </div>
                    </div>
                    <div class="col-12 col-md-4">
                        <div class="kpi-card">
                            <div class="kpi-label" style="font-weight:600">New Service Providers (This month)</div>
                            <div id="newServiceProvidersThisMonth" class="kpi-value text-warning">@Model.KycSummary?.NewServiceProvidersThisMonth</div>
                        </div>
                    </div>
                </div>

                <div class="row g-3 mb-4">
                    <!-- Second row -->
                    <div class="col-12 col-md-4">
                        <div class="kpi-card">
                            <div class="kpi-label" style="font-weight:600">IDs verified (This month)</div>
                            <div id="totalSuccessfulKycsThisMonth" class="kpi-value text-success">@Model.KycSummary?.TotalSuccessfulKycsThisMonth</div>
                        </div>
                    </div>
                    <div class="col-12 col-md-4">
                        <div class="kpi-card">
                            <div class="kpi-label" style="font-weight:600">Failed ID Proofings</div>
                            <div id="totalFailedKycs" class="kpi-value text-danger">@Model.KycSummary?.TotalFailedKycs</div>
                        </div>
                    </div>
                    <div class="col-12 col-md-4">
                        <div class="kpi-card">
                            <div class="kpi-label" style="font-weight:600">Verification Success Rate</div>
                            <div id="verificationSuccessRate" class="kpi-value text-success">@successRate.ToString("0.##")%</div>
                        </div>
                    </div>
                </div>



                <div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title mb-4 mt-3" style="font-size:15px !important;">Recent IDs Verified :</h5>
                        <div class="total-devices d-flex align-items-center">
                            <p class="total-label p-0">Total Devices Registered :</p>
                            <div class="device-count-cards" id="deviceDigitContainer">
                                @foreach (var digit in totalDevices)
                                {
                                    <span class="digit-card">@digit</span>
                                }
                            </div>
                        </div>
                    </div>

                    <div id="recentServiceProvidersList" class="space-y-4"></div>
                    <div id="noRecentDataMessageServiceProvider" class="text-center mt-2 mb-2" style="display:none;">
                        <div style="color:#4e5e6a;font-size:1.2rem;">No ID Proofing's found.</div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="row d-none g-4 mb-4">
                    <div class="" style="width:70%;">
                        <!-- Recent Applications Table -->
                        <div class="card shadow-sm mb-0">
                            <div class="card-body">
                                <h5 class="card-title mb-3">Recent IDs Verified</h5>
                                <div class="table-responsive">
                                    <table class="table align-middle">
                                        <thead>
                                            <tr>
                                                <th>ID Number</th>
                                                <th>Name</th>
                                                <th>Verified on</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var item in Model.Reports.Take(5))
                                            {
                                                <tr>
                                                    <td>@item.identifier</td>
                                                    <td>@item.name</td>
                                                    <td>@item.date</td>
                                                    <td>
                                                        <span class="status-badge status-@item.status?.ToLowerInvariant()">
                                                            @item.status
                                                        </span>
                                                    </td>

                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>

                            </div>
                        </div>
                    </div>
                    <div class="" style="width:30%;">
                        <div class="card h-100 shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title mb-5">Risk Exposure</h5>
                                <div class="chart-responsive" style="position: relative; height:300px; width:100%;">
                                    <canvas id="riskChart" style="width:75% !important; height:80% !important;"></canvas>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Compliance & Info Section -->
                @* <div class="card shadow-sm mb-5">
                    <div class="card-body">
                        <h5 class="card-title">Compliance & Regulatory Notes</h5>
                        <p class="mb-0 mt-2 ml-3" style="text-align:left;">
                            All IDs Verification processes adhere to current local and international regulations. Regular audits and automated checks ensure ongoing compliance and data integrity. For more details, contact your compliance officer.
                        </p>
                    </div>
                </div> *@
            </div>
            <!-- Organization Stats Tab -->
            <div class="tab-pane" id="org" role="tabpanel" style="display:none;">
                <div id="serviceProviderList"></div>
            </div>
        </div>


    </div>
</div>


<div class="modal fade" id="responseModal" tabindex="-1" aria-labelledby="responseModalLabel" aria-hidden="true">
    <div class="modal-dialog custom-modal-width modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header d-flex align-items-center justify-content-between response-tabs-wrapper">
                <ul class="nav nav-tabs" id="responseTabs" role="tablist">
                    <li class="nav-item mr-2" role="presentation" style="cursor:pointer;">
                        <button class="nav-link active" id="request-tab" data-bs-toggle="tab" data-bs-target="#requestContent" type="button" role="tab">Request</button>
                    </li>
                    <li class="nav-item mr-2" role="presentation" style="cursor:pointer;">
                        <button class="nav-link" id="signed-tab" data-bs-toggle="tab" data-bs-target="#signedContent" type="button" role="tab">Response</button>
                    </li>
                    <li class="nav-item d-none" role="presentation" id="verified-tab-wrapper" style="cursor:pointer;">
                        <button class="nav-link" id="verified-tab" data-bs-toggle="tab" data-bs-target="#verifiedContent" type="button" role="tab">Verified Response</button>
                    </li>
                </ul>
            </div>


            <div class="modal-body custom-modal-body pt-1">

                <div class="tab-content mt-3" id="responseTabContent">
                    <div class="tab-pane fade show active" id="requestContent" role="tabpanel" aria-labelledby="request-tab">
                        <div class="request-response-content" style="word-break: break-word;"></div>
                    </div>
                    <div class="tab-pane fade" id="signedContent" role="tabpanel" aria-labelledby="signed-tab">
                        <div class="signed-response-content" style="word-break: break-word;"></div>
                    </div>
                    <div class="tab-pane fade" id="verifiedContent" role="tabpanel" aria-labelledby="verified-tab">
                        <div class="verified-response-content" style="word-break: break-word;">Verification pending...</div>
                    </div>
                </div>
            </div>


            <div class="modal-footer">
                <div id="verifyResultBadge" class="mr-2" style="display: none;"></div>
                <button type="button" class="btn btn-primary" id="verifySignedResponseBtn">Verify</button>
                <!-- Print Button with Icon -->
                <button type="button" class="btn btn-info" id="printBtn" style="display: none;">
                    Report
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


<form id="printForm" method="post" action="@Url.Action("PrintIdValidationData", "KycDashboard")">
    <input type="hidden" name="SignedData" id="printSignedData" />
    <input type="hidden" name="VerificationResponse" id="printVerificationResponse" />
</form>

<script>

        let currentTab = "overall";
     const recentServiceProviders = @Html.Raw(Json.Serialize(Model.Reports));
         let currentUserData = null;

    $(document).ready(function () {

        $('#kycDashboardMenu').addClass('active');


        /*For Beadcrum Start*/
        $('#homeMenu').addClass('breadcrumb-item').append('Dashboard');
        $('#mainMenu').removeClass('breadcrumb-item');
        $('#subMenu').removeClass('breadcrumb-item');



            

            const tabButtons = document.querySelectorAll("#kycTab .nav-link");
            const tabContents = {
                overall: document.getElementById("overall"),
                org: document.getElementById("org")
            };

            tabButtons.forEach(btn => {
                btn.addEventListener("click", function () {
                    // Remove active class from all tabs
                    tabButtons.forEach(b => b.classList.remove("active"));

                    // Hide all tab contents
                    Object.values(tabContents).forEach(content => content.style.display = "none");

                    // Set active class to clicked button
                    this.classList.add("active");

                    // Show corresponding content
                    const tabId = this.id.replace("-tab", "");
                    tabContents[tabId].style.display = "block";

                        //Set current tab
                    currentTab = tabId;
                });
            });

            // Initially show "overall" tab
            $('#overall-tab').addClass('active');
            $('#overall').css('display', 'block');




        loadServiceProviders();


        $('#printBtn').on('click', function () {
            if (!lastVerificationResponse || !currentUserData) {
                alert("No verified response to print.");
                return;
            }

            // Fill hidden inputs
            $('#printSignedData').val(JSON.stringify(lastVerificationResponse));
            $('#printVerificationResponse').val(JSON.stringify(currentUserData));

            // $('#printForm').submit();
            $('#printForm')
            .attr('target', '_blank') // ✅ forces new page
            .submit();
        });




        const urlParams = new URLSearchParams(window.location.search);
        const tabParam = urlParams.get("tab");

        if (tabParam === "org") {
            // Simulate click on Service Providers tab
            document.getElementById("org-tab").click();
            window.history.replaceState({}, document.title, window.location.pathname);
        }


        $(document).on('click', '.view-response-btn', function () {
            const encoded = $(this).data('item');
            const item = JSON.parse(atob(encoded));
            currentSignedResponse = item.signedResponse;
            currentUserData = item;
            currentKycMethod = item.kycMethod;

                //set request body
            appendRequestBody(item);

            // Set signed response
            $('#responseModal .signed-response-content').html(
                item.signedResponse && item.signedResponse.trim() ? item.signedResponse : 'No Data Found'
            );

            // Hide verified tab initially
            $('#verified-tab-wrapper').addClass('d-none');
            $('#verifiedContent').removeClass('show active');

                // Ensure request tab is active
            $('#request-tab').addClass('active');
            $('#requestContent').addClass('show active');

            // Ensure signed tab is inactive
            $('#signed-tab').removeClass('active');
            $('#signedContent').removeClass('show active');


            $('#verified-tab').removeClass('active');
            $('#signed-tab').removeClass('d-none');

            $("#printBtn").hide();
            $('#verifyResultBadge').hide().html('');


            // Toggle verify button visibility
            if (!item.signedResponse || item.signedResponse.trim() === '') {
                $('#verifySignedResponseBtn').hide();
            } else {
                $('#verifySignedResponseBtn').show();
            }

            const modalEl = document.getElementById('responseModal');
            responseModalInstance = new bootstrap.Modal(modalEl);
            responseModalInstance.show();
        });



            function appendRequestBody(item) {
            const req = item.request || {};
            const imageSectionParts = [];

            // Field-to-label mapping
            const fieldLabels = {
                idNumber: "ID Number",
                 name: "Name",
                dateOfBirth: "Date of Birth",
                customerPhoneNumber: "Customer Phone Number",
                customerEmail: "Customer Email",
                cardNumber: "Card Number",
                documentType: "Document Type",
                documentNumber: "Document Number",
                documentNationality: "Document Nationality",
                expiryDate: "Expiry Date",
                width: "Width",
                height: "Height",
                fingerIndex: "Finger Index",
                remoteVerificationdata: "Remote Verification Data",
                manualEntry: "Manual Entry",
                authentication: "Authentication",

            };

            // Handle images
            if (req.faceImage?.trim()) {
                imageSectionParts.push(`<div class="mb-3">
                    <img src="data:image/jpeg;base64,${req.faceImage}"
                         alt="Face Image"
                         style="width: 100px; height: 120px;  object-fit: cover;">
                </div>`);
            }

            // if (req.capturedFingerImage?.trim()) {
            //     imageSectionParts.push(`<div class="mb-3 ml-4">
            //         <img src="data:image/jpeg;base64,${req.capturedFingerImage}"
            //              alt="Finger Image"
            //              style="width: 100px; height: 120px;  border-radius: 8px; object-fit: cover;">
            //     </div>`);
            // }
            if (req.capturedFingerImage?.trim()) {
                imageSectionParts.push(`<div class="mb-3 ml-4">
                    <img src="@Url.Content("~/images/fingerprint.png")"
                    alt="Finger Image"
                    style="width: 80px; height: 90px;  border-radius: 8px; object-fit: cover;">
                    </div>`);
            }

            if (req.passportImage?.trim()) {
                imageSectionParts.push(`<div class="mb-3 ml-4">
                    <img src="data:image/jpeg;base64,${req.passportImage}"
                         alt="Passport Image"
                         style="width: 100px; height: 120px;  border-radius: 8px; object-fit: cover;">
                </div>`);
            }

            // Prepare details section
            let detailsSection = "";
            for (const [field, label] of Object.entries(fieldLabels)) {
                const value = req[field];
                if (value !== undefined && value !== null && value.toString().trim() !== "") {
                    detailsSection += `
                        <div class="mb-2 col-12 d-flex">
                            <strong style="width: 200px;white-space:nowrap;">${label}:</strong>
                            <span style="padding:2px;">${value}</span>
                        </div>
                    `;
                }
            }

            const html = `
                <div class="d-flex flex-column gap-4 ml-2">
                    <div class="image-section d-flex gap-3">
                        ${imageSectionParts.join("")}
                    </div>
                    <div class="flex-grow-1 row mt-1">
                        ${detailsSection }
                    </div>
                </div>
            `;

            $('#responseModal .request-response-content').html(html);
        }


        // Modal close handler
        $(document).on('click', '#responseModal .btn-close, #responseModal .btn-secondary', function () {
            if (responseModalInstance) {
                responseModalInstance.hide();
            }
        });


    });


     function refreshDashboardData() {
         hasNewUpdates = false;
         lastRefreshTime = Date.now();
         $('#recentServiceProvidersList').empty();
         const shimmerElement = showShimmer(5);
         $.ajax({
             url: '@Url.Action("GetDashboardDataAsync", "KycDashboard")',
             method: 'GET',
             success: function (data) {
                 const summary = data.summary;
                 const records = data.records;
                 // ✅ Update summary fields
                     document.getElementById('totalSuccessfulKycsThisMonth').innerHTML = summary.totalSuccessfulKycsThisMonth;
    document.getElementById('totalFailedKycs').innerHTML = summary.totalFailedKycs;
    document.getElementById('totalServiceProviders').innerHTML = summary.totalServiceProviders;
    document.getElementById('totalSuccessfulKycs').innerHTML = summary.totalSuccessfulKycs;
    document.getElementById('newServiceProvidersThisMonth').innerHTML = summary.newServiceProvidersThisMonth;


                 const success = summary.totalSuccessfulKycs || 0;
                 const fail = summary.totalFailedKycs || 0;
                 const rate = (success + fail) > 0 ? (success * 100) / (success + fail) : 0;
                 // ✅ Update success rate field
                 $('#verificationSuccessRate').text(rate.toFixed(2) + '%');


                 // ✅ Convert totalDevices to string and split into digits
                 const deviceCountStr = (summary.totalKycDevices || 0).toString();
                 const container = $('#deviceDigitContainer');

                 container.empty(); // Clear previous digits

                 for (let i = 0; i < deviceCountStr.length; i++) {
                     const digit = $('<span>').addClass('digit-card').text(deviceCountStr[i]);
                     container.append(digit);
                 }


                 shimmerElement.remove();
                 renderAndAppendServiceProviders(records);

             },
             error: function (err) {
                 console.error("Dashboard data fetch failed:", err);
                 alert("Unable to load dashboard data. Please try again.");
             }
         });
     }



     function loadServiceProviders() {

         //const shimmerElement = showShimmer(5);
         if (!recentServiceProviders || recentServiceProviders.length === 0) {
             $('#noRecentDataMessageServiceProvider').show();
         }
         renderAndAppendServiceProviders(recentServiceProviders);

     }







     function showSignedResponseModal(signedResponse) {
         currentSignedResponse = signedResponse;
         $('.signed-response-content').text(signedResponse);
         $('#verifyResultBadge').hide().html(""); // reset badge
         const modal = new bootstrap.Modal(document.getElementById('responseModal'));
         modal.show();
    }



    $('#verifySignedResponseBtn').on('click', function () {
    if (!currentSignedResponse) {
        alert("No signed response available.");
        return;
    }
    $('#networkOverlay').show();

        $.ajax({
                url: '@Url.Action("ValidateSignedData", "IdValidation")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ SignedData: currentSignedResponse , KycMethod: currentKycMethod}),
                   success: function (response) {
                        const badgeContainer = $('#verifyResultBadge');
                        const verifyBtn = $('#verifySignedResponseBtn');
                        badgeContainer.show();
                        $('#networkOverlay').hide();

                        if (response.success) {
                            $("#printBtn").show();
                            lastVerificationResponse = response.result; // store response for print
                            badgeContainer.html(`
                                <span class="p-2" style="background-color:green;color:white;font-size: 0.95rem;padding:5px 10px !important;border-radius:16px;">
                                    VERIFIED
                                </span>
                            `);
                            verifyBtn.hide();

                            // Show and activate the Verified tab
                            $('#verified-tab-wrapper').removeClass('d-none');
                            const verifiedHtml = formatVerifiedData(response.result);
                            $('.verified-response-content').html(verifiedHtml);



                        } else {
                            swal({
                                type: 'info',
                                title: "Info",
                                text: `Signed Response verified Failed`,
                                showCancelButton: false,
                                closeOnConfirm: true
                            });
                        }
                    },

                error: function (xhr, status, error) {
                    $('#networkOverlay').hide();
                    alert("❌ Error occurred during verification:\n" + error);
                }
            });
    });


       function cropFileNames(full) {
           let start, end;
           start = 25;
           end = 25;

           if (full && full.length > start + end) {
               return full.slice(0, start) + '...' + full.slice(-end);
           } else {
               return full
           }
       }



            // Format the response.result into HTML
           function formatVerifiedData(response) {
                const fallbackImage = '@Url.Content("~/images/user.png")';// Use your actual default image path

                const originalName = response.name?.trim() || 'N/A';
                const croppedName = cropFileNames(originalName);
                const titleAttr = croppedName !== originalName ? ` title="${originalName}"` : '';

                const nationality = response.nationality?.trim() || 'N/A';
                const idNumber = response.idNumber?.trim() || 'N/A';
                const issueDate = response.issueDate?.trim() || 'N/A';
                const expiryDate = response.expiryDate?.trim() || 'N/A';
                const gender = response.gender?.trim() || 'N/A';
                const dob = response.dob?.trim() || 'N/A';
            const documentStatus = response.documentStatus?.trim() || '';


                const rawPhoto = response.photo;
                const photoSrc = rawPhoto
                    ? (rawPhoto.startsWith('data:image') ? rawPhoto : `data:image/jpeg;base64,${rawPhoto}`)
                    : fallbackImage;

                            return `
                    <h5 class="mb-3" style="font-size:20px !important;margin:0;">Verified Details:</h5>
                    <div class="d-flex row flex-wrap align-items-start gap-3" style="padding-left:4%">
                        <div class="col-2 text-center me-3">
                            <img src="${photoSrc}"
                                 alt="Cardholder Photo"
                                 style="width: 100px; height: 100px; object-fit: cover; border-radius: 50%; border: 2px solid #ccc;">
                        </div>
                        <div class="col-9" style="padding-left:4%">
                                <div class="mb-2 d-flex "><div><strong>Name:</strong></div><div ${titleAttr}>${croppedName}</div></div>
                            <div class="mb-2"><strong>Nationality:</strong> ${nationality}</div>
                            <div class="mb-2"><strong>ID Number:</strong> ${idNumber}</div>
                            <div class="mb-2"><strong>Issue Date:</strong> ${issueDate}</div>
                            <div class="mb-2"><strong>Expiry Date:</strong> ${expiryDate}</div>
                            <div class="mb-2"><strong>Gender:</strong> ${gender}</div>
                            <div class="mb-2"><strong>Date of Birth:</strong> ${dob}</div>
                    ${documentStatus ? `<div class="mb-2"><strong>Document Status:</strong> ${documentStatus}</div>` : ''}
                        </div>
                    </div>
                `;}




    function renderAndAppendServiceProviders(data) {
        const container = $('#recentServiceProvidersList');

        // Only take the first 5 items
        const topFive = data.slice(0, 5);

        const cards = topFive.map(item => generateServiceProviderCardHtml(item));
        container.append(cards.join(''));
        updateDateStamps();
        updateDateTimeStamps();
    }


    function showShimmer(count) {
        let shimmerHtml = `<div class="shimmer-wrapper">`;
        for (let i = 0; i < count; i++) {
            shimmerHtml += `<div class="shimmer-item"></div>`;
        }
        shimmerHtml += `</div>`;
        const $shimmer = $(shimmerHtml);
        $('#recentServiceProvidersList').append($shimmer);


        return $shimmer;
    }



    function generateServiceProviderCardHtml(item) {
        const status = item.status.toLowerCase();
        let cardClass = '', badgeClass = '';
        const encodedData = btoa(JSON.stringify(item));
        let base64Image = item.photo || '';
        let fullDataUrl = '';

        if (base64Image.startsWith('data:image')) {
            fullDataUrl = base64Image; // Already a complete data URL
        } else {
            const imageType = 'png'; // or dynamically detect type
            fullDataUrl = `data:image/${imageType};base64,${base64Image}`;
        }


        switch (status) {
            case 'success':
                cardClass = 'status-active';
                badgeClass = 'status-badge-active';
                break;
            case 'failure':
                cardClass = 'status-inactive';
                badgeClass = 'status-badge-inactive';
                break;

        }

        // const kycMethodsHtml = `
        //   <span class="badge bg-success text-white mr-3 mb-1 d-flex justify-content-center align-items-center" style="padding:10px 12px !important;font-size:10px !important;">
        //     ${item.kycMethod}
        //   </span>
        // `;

            let icon = '';
        let customClass = 'bg-success text-white'; // default
        let customStyle = 'padding:10px 12px !important; font-size:10px !important;'; // default

        if (item.kycMethod.toUpperCase().includes('FACE')) {
          icon = `<img src="@Url.Content("~/images/face.png")" alt="Face" style="width:14px; height:14px; margin-right:6px;">`;
          customClass = '';
          customStyle += 'background-color:#f1f410b3; color:black;';
        } else if (item.kycMethod.toUpperCase().includes('FINGERPRINT')) {
          icon = `<img src="@Url.Content("~/images/fingerprint.png")" alt="Fingerprint" style="width:14px; height:14px; margin-right:6px;">`;
          customClass = '';
          customStyle += 'background-color:#f1f410b3; color:black;';
        }

        const kycMethodsHtml = `
          <span class="badge ${customClass} mr-3 mb-1 d-flex justify-content-center align-items-center" style="${customStyle}">
            ${icon}${item.kycMethod}
          </span>
        `;


        const imageHtml = base64Image
            ? `<img src="${fullDataUrl}" alt="Logo" style="width: 60px; height: 60px; object-fit: contain;" class="rounded border" />`
            : `<i class="fa fa-user-circle fa-2x" style="width: 60px; height: 60px; display: inline-flex; align-items: center; justify-content: center; font-size: 40px;"></i>`;


        return `
<div class="card service-provider-card  mb-3 p-3" id="sp-${item.identifier}">
    <div class="d-flex flex-column gap-3">

        <!-- Header Section -->
        <div class="d-flex justify-content-between flex-wrap gap-3">

            <!-- Left: Logo and Org Details -->
            <div class="d-flex gap-3 align-items-start">
                ${imageHtml}
                <div class="ml-2">
                        <h5 class="mb-1 fw-semibold text-dark mt-1" style="font-size:15px !important;"
                            ${item.name && item.name.length > 40 ? `title="${item.name}"` : ''}>
                            ${item.name
                ? (item.name.length > 50
                    ? item.name.substring(0, 40) + '...'
                    : item.name)
                : 'NA'}
                        </h5>


                    <div class="sp-label-heading mb-1">
                        ID Number : <span>${item.identifier}</span>
                    </div>
                    <div class="sp-label-heading">
                        Nationality: <span>${item.nationality ? item.nationality : 'NA'}</span>
                    </div>

                </div>
            </div>

            <!-- Right: Status and KYC Info (Neatly Aligned) -->
            <div class="d-flex flex-wrap gap-3 align-items-center justify-content-end text-end ms-auto">

                <div class="d-none flex-column mr-5" style="min-width:100px;">
                    <div style="font-weight:600;">${item.orgName}</div>
                    <div class="sp-label-heading">Service Provider</div>
                </div>

                <div class="d-none flex-column mr-5" style="min-width:100px;">
                    <div style="font-weight:600;">${item.date}</div>
                    <div class="sp-label-heading">Date</div>
                </div>

                <div class="d-none flex-column mr-5" style="min-width:100px;">
                    <div style="font-weight:600;">${item.time}</div>
                    <div class="sp-label-heading">Time</div>
                </div>

                    <div class="d-flex flex-column mr-5" style="min-width:100px;text-align:center">



                        <div class="sp-label-heading">Card Expiry Date</div>
                       <div style="font-weight:600;">
                          ${
                            item.expiryDate
                              ? (() => {
                                  const dateParts = item.expiryDate.split("-"); // [yyyy, mm, dd]
                                  const formattedDate = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;
                                  return `<span>${formattedDate}</span>`;
                                })()
                              : `<span>NA</span>`
                          }
                        </div>
                    </div>



                <div class="d-flex flex-column justify-content-center align-items-center" style="min-width:150px;">
                    <span class="badge ${badgeClass} text-uppercase px-3 py-1 fw-semibold d-flex justify-content-center align-items-center" style="width:100px;padding:16px 8px !important;">${item.status}</span>
                </div>

            </div>

        </div>

        <!-- KYC Methods Section -->
        <div class="border-top pt-3 mt-2 d-flex justify-content-between align-items-center">
            <div>
                 <div class="text-muted small d-flex align-items-center">
                    <span class="sp-label-heading mr-2">ID Validation Method : </span>
                    ${kycMethodsHtml}
                </div>
                 <div class="text-muted small d-flex align-items-center">
                    <span class="sp-label-heading mr-2 mb-0">Service Provider : </span>
                    <span style="font-weight:bold;">${item.orgName}</span>
                </div>
            </div>
           <div class="d-flex">
                     <div class="d-flex flex-column mr-5" style="min-width:100px;text-align:center">

                        <div class="sp-label-heading">ID Verification Date & Time</div>
                        <div style="font-weight:600;">
                                <span class="convert-date-time" data-datetimestamp="${item.validationDateTime}" style="font-weight:600;">${item.validationDateTime}</span>
                        </div>
                    </div>
               <div class="d-flex justify-content-center" style="min-width:150px;">
                    <button type="button" style="max-height:35px;" class="btn btn-primary view-response-btn" data-item='${encodedData}'>
                      Response
                    </button>
               </div>
           </div>

        </div>
        </div>
    </div>
</div>
`;

    }



    $('#org-tab').on('click', function () {
        var tabTrigger = new bootstrap.Tab(this);
        tabTrigger.show();

        // Load the partial view via AJAX only once
        if ($('#serviceProviderList').is(':empty')) {
            $.ajax({
                url: '@Url.Action("serviceProvider", "KycDashboard")',
                type: 'GET',
                success: function (response) {
                    $('#serviceProviderList').html(response);
                },
                error: function () {
                    $('#serviceProviderList').html('<p>Failed to load content.</p>');
                }
            });
        }
    });



        // Risk Exposure Pie Chart (Success vs Failed)
    new Chart(document.getElementById('riskChart').getContext('2d'), {
        type: 'pie',
        data: {
            labels: ['Successful KYCs', 'Failed KYCs'],
            datasets: [{
                data: [@successful, @failed],
                backgroundColor: [
                    'rgba(40, 167, 69, 0.7)', // green for success
                    'rgba(220, 53, 69, 0.7)'  // red for fail
                ],
                borderColor: [
                    'rgba(40, 167, 69, 1)',
                    'rgba(220, 53, 69, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
                plugins: {
            legend: {
                position: 'bottom', // or 'left'
                labels: {
                    usePointStyle: true, // optional: use circle instead of box
                    padding: 20
                }
            }
        }

        }
    });




</script>
<script>
    const REFRESH_INTERVAL = 30000;
    const DEBOUNCE_DELAY = 2000;

    let hasNewUpdates = false;
    let debounceTimer;
    let lastRefreshTime = Date.now();

    var kafkaHubUrl = "@kafkaUrl";
    const connection = new signalR.HubConnectionBuilder()
        .withUrl(kafkaHubUrl)
        .withAutomaticReconnect()
        .configureLogging(signalR.LogLevel.Information)
        .build();

    connection.on("SendLog", function (count) {
        

        hasNewUpdates = true;


        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            if (hasNewUpdates) {
            refreshDashboardData();
            if (currentTab === "org") {
                document.getElementById("org-tab").click();
            }
            }
        }, DEBOUNCE_DELAY);
    });

    connection.start().catch(function (err) {
        console.error("SignalR connection error:", err.toString());
    });

    setInterval(() => {
      const now = Date.now();
      if (hasNewUpdates && (now - lastRefreshTime >= REFRESH_INTERVAL)) {
        refreshDashboardData();
        if (currentTab === "org") {
            document.getElementById("org-tab").click();
        }
      }
    }, 5000);
</script>
<script src="~/assets/js/bootstrap-5.3.3.js"></script>
