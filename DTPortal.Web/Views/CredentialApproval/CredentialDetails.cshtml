@model DTPortal.Web.ViewModel.CredentialApproval.CredentialDetailsViewModel

<div class="row">
    <div class="col-md-12">
        <div class="card-custom">
            <div class="card-body">
                <form id="uform" enctype="multipart/form-data" asp-action="Update">
                    <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                    <!-- Full width for input fields and logo -->
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <div class="form-group" hidden>
                                <input asp-for="Id" class="form-control" />
                            </div>
                            <div class="form-group" hidden>
                                <input style="background-color:white;" asp-for="credentialUId" class="form-control" />
                            </div>
                            <div class="form-group">
                                <label asp-for="DisplayName" class="col-form-label"></label>
                                <input style="background-color:white;" asp-for="DisplayName" class="form-control" readonly />
                                <span asp-validation-for="DisplayName" class="text-danger"></span>
                            </div>
                            <div class="form-group">
                                <label asp-for="CredentialName" class="col-form-label"></label>
                                <input style="background-color:white;" asp-for="CredentialName" class="form-control" readonly />
                                <span asp-validation-for="CredentialName" class="text-danger"></span>
                            </div>
                            <div class="form-group">
                                <label asp-for="trustUrl" class="col-form-label"></label>
                                <input style="background-color:white;" asp-for="trustUrl" class="form-control" readonly />
                                <span asp-validation-for="trustUrl" class="text-danger"></span>
                            </div>
                            <div class="form-group">
                                <label asp-for="authenticationScheme" class="col-form-label"></label>
                                <input style="background-color:white;" asp-for="authenticationScheme" class="form-control" readonly />
                                <span asp-validation-for="authenticationScheme" class="text-danger"></span>
                            </div>
                            <div class="form-group">
                                <label asp-for="organizationName" class="col-form-label"></label>
                                <input style="background-color:white;" asp-for="organizationName" class="form-control" readonly />
                                <span asp-validation-for="organizationName" class="text-danger"></span>
                            </div>
                            <!-- <div class="form-group">
                                  <label asp-for="createdDate" class="col-form-label"></label>
                                  <input asp-for="createdDate" class="form-control" readonly />
                                  <span asp-validation-for="createdDate" class="text-danger"></span>
                              </div>
                                -->
                        </div>

                        <div class="form-group col-md-6">

                            <div class="form-group">
                                <label asp-for="categoryName" class="col-form-label"></label>
                                <input style="background-color:white;" asp-for="categoryName" class="form-control" readonly />
                                <span asp-validation-for="categoryName" class="text-danger"></span>
                            </div>
                            <div class="form-group">
                                <label asp-for="status" class="col-form-label"></label>
                                <input style="background-color:white;" asp-for="status" class="form-control" readonly />
                                <span asp-validation-for="status" class="text-danger"></span>
                            </div>
                            <div class="form-group">
                                @if (Model != null && !string.IsNullOrEmpty(Model.logo))
                                {
                                    <div class="form-group">
                                        <label asp-for="logo" class="col-form-label"></label>
                                        <div class="border p-2 logo-container">
                                            <img src="data:image/png;base64,@Model.logo" alt="Logo" class="logo-image" />
                                        </div>
                                    </div>
                                }
                            </div>
                            @*                             <div class="form-group d-flex align-items-center">
                            <label class="col-form-label mr-2">Consent Document</label>
                            @if (!string.IsNullOrEmpty(Model.signedDocument))
                            {
                            <a href="@Model.signedDocument" target="_blank" class="btn btn-sm btn-info">View</a>
                            }
                            else
                            {
                            <span class="text-muted">No document available</span>
                            }
                            </div>
                            *@

                        </div>
                    </div>

                    <!-- Full width for Data Attributes table -->
                    <div class="form-row">
                        <div class="form-group col-md-12">
                            <label asp-for="dataAttributes" class="col-form-label s3">Attributes</label>

                            <div style="height: 300px; overflow-y: auto; border: 1px solid #D3D3D3;">
                                <table id="AttributeTable" class="table table-bordered table-hover table-checkable order-column full-width">
                                    <thead>
                                        <tr style="background-color: #F5F5F5; border-bottom: 2px solid #D3D3D3;">
                                            <th style="padding: 12px; text-align: center; border-right: 1px solid #E0E0E0;">Attribute</th>
                                            <th style="padding: 12px; text-align: center; border-right: 1px solid #E0E0E0;">Display Name</th>
                                            <th style="padding: 12px; text-align: center;">Data Type</th>

                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var item in Model.dataAttributes)
                                        {
                                            <tr style="border-bottom: 1px solid #E0E0E0;">
                                                <td style="padding: 10px; border-right: 1px solid #E0E0E0; text-align: center;">@item.attribute</td>
                                                <td style="padding: 10px; border-right: 1px solid #E0E0E0; text-align: center;">@item.displayName</td>
                                                <td style="padding: 10px; text-align: center;">
                                                    @{
                                                        string dataTypeName = item.dataType switch
                                                        {
                                                            1 => "Binary",
                                                            2 => "Boolean",
                                                            3 => "Integer",
                                                            4 => "String",
                                                            8 => "DateTime",
                                                            _ => "Unknown"
                                                        };
                                                        @dataTypeName
                                                    }
                                                </td>

                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <style>
                        .table-container {
                            max-height: 300px; /* Adjust the max height as needed */
                            overflow-y: auto;
                        }

                        /* Alternating row colors */
                        #data-attributes-list tbody tr:nth-child(even) {
                            background-color: #f2f2f2; /* Light grey for even rows */
                        }

                        #data-attributes-list tbody tr:nth-child(odd) {
                            background-color: #ffffff; /* White for odd rows */
                        }

                        /* Optional: Add a hover effect for rows */
                        #data-attributes-list tbody tr:hover {
                            background-color: #dcdcdc; /* Darker grey on hover */
                        }

                        .logo-container {
                            max-width: 200px; /* Maximum width */
                            max-height: 200px;
                            height: 135px;
                            width: 200px; /* Maximum height */
                            border-radius: 4px;
                            border: solid;
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            overflow: hidden;
                        }

                        .logo-image {
                            width: 100px;
                            height: 100px;
                            max-height: 120px;
                            max-width: 120px;
                        }

                        #AttributeTable tbody tr:nth-child(odd) {
                            background-color: transparent !important;
                        }

                    </style>


                    <!-- Bottom buttons (Approve, Reject, Cancel) -->
                    <div class="d-flex justify-content-between align-items-center" style="padding-right: 10px; padding-top: 31px;">
                        @*                         <a type="button" id="previewButton" class="btn btn-primary mr-auto" data-toggle="modal" data-target="#previewModal">
                        View Consent Document
                        </a> *@

                        <div class="d-flex ml-auto">
                            @if (@Model.status == "APPROVAL_REQUIRED")
                            {
                                @*                                 <a type="button" class="btn btn-primary ml-2" data-toggle="modal" data-target="#approveModal">
                                    Approve
                                </a> *@
                                <a type="button" class="btn btn-primary ml-2" data-toggle="modal" onclick="showApprovalModal()">Approve</a>

                                <a id="rejectButton" class="btn btn-danger ml-2">
                                    Reject
                                </a>
                            }
                            @if (@Model.status == "REJECTED")
                            {
                                <a id="remarks" class="btn btn-info ml-2" data-toggle="modal" data-target="#remarksModal">
                                    Remarks
                                </a>
                            }
                            <a asp-action="Index" class="btn btn-secondary ml-2">
                                Cancel
                            </a>
                        </div>
                    </div>

                </form>
            </div>
        </div>
    </div>
</div>
<script src="https://mozilla.github.io/pdf.js/build/pdf.js"></script>

@section scripts {
    <script>

        var dataAttributes = JSON.parse('@Html.Raw(Json.Serialize(Model.dataAttributes))');

        $(document).ready(function () {
            $('#walletMenu').addClass('active');
            $('#credentialMenuItem').addClass('active');
            $('#walletConfig').addClass('show');
            $("li#walletMenu a:first").attr('aria-expanded', 'true');
            $("li#credentialMenuItem a:first").attr('aria-expanded', 'true');

            /*For Breadcrumb Start*/
            $('#homeMenu').addClass('breadcrumb-item').append(' Digital Wallet');
            $('#mainMenu').addClass('breadcrumb-item active').append('Credential Approval List');
            $('#subMenu').addClass('breadcrumb-item').append('View');

            var table = $("#clientTable").DataTable({
                "bLengthChange": false,
                "searching": true,
                "ordering": true,
                "order": [[0, "desc"]]
            });
        });

        $(document).ready(function () {

            $('#previewButton').click(function () {
                var base64Data = '@Html.Raw(Model.signedDocument)';

                if (!base64Data || base64Data.trim() === "") {
                    alert("No signed document available for preview.");
                    return;
                }

                try {
                    // Show loader and hide canvas
                    $('#pdfLoader').show();
                    $('#pdfCanvas').hide();

                    // Convert Base64 to Binary
                    var pdfData = atob(base64Data);
                    var pdfUint8Array = new Uint8Array(pdfData.length);
                    for (var i = 0; i < pdfData.length; i++) {
                        pdfUint8Array[i] = pdfData.charCodeAt(i);
                    }

                    // Load PDF using PDF.js
                    var loadingTask = pdfjsLib.getDocument({ data: pdfUint8Array });
                    loadingTask.promise.then(function (pdf) {
                        pdf.getPage(1).then(function (page) {
                            var canvas = document.getElementById("pdfCanvas");
                            var context = canvas.getContext("2d");
                            var viewport = page.getViewport({ scale: 1.5 });

                            canvas.width = viewport.width;
                            canvas.height = viewport.height;

                            var renderContext = {
                                canvasContext: context,
                                viewport: viewport
                            };

                            page.render(renderContext).promise.then(function () {
                                // Hide loader and show canvas after rendering
                                $('#pdfLoader').hide();
                                $('#pdfCanvas').show();
                                $('#pdfPreviewModal').modal('show'); // Show modal after rendering
                            });
                        });
                    }).catch(function (error) {
                        console.error("Error loading PDF:", error);
                        alert("Failed to display the signed document.");
                        $('#pdfLoader').hide(); // Hide loader if an error occurs
                    });
                } catch (error) {
                    console.error("Error displaying PDF:", error);
                    alert("Failed to display the signed document.");
                    $('#pdfLoader').hide(); // Hide loader in case of any error
                }
            });



            // $("#approveButton").click(function () {
            //     var credentialUid = '@Model.credentialUId'; // Replace this dynamically if needed

            //     $.ajax({
            //         url: '@Url.Action("Approve", "CredentialApproval")', // Update with your actual controller method
            //         type: "POST",
            //         data: { uid: credentialUid },
            //         success: function (response) {
            //             $('#approveModal').modal('hide');
            //             window.location.href = '@Url.Action("Index", "CredentialApproval")';
            //         },
            //         error: function () {
            //             window.location.href = '@Url.Action("Index", "CredentialApproval")';
            //         }
            //     });
            // });




            // Handle Reject button click
            $('#rejectButton').click(function () {
                $('#rejectModal').modal('show');
            });

            // Handle Reject form submission inside the modal
            $('#rejectForm').submit(function (e) {
                e.preventDefault(); // Prevent default form submission

                var credentialUId = '@Model.credentialUId';
                var remarks = $('#rejectRemarks').val();

                $.ajax({
                    url: '@Url.Action("Reject", "CredentialApproval")',
                    type: 'POST',
                    data: { uid: credentialUId, remarks: remarks },
                    success: function (response) {
                        $('#rejectModal').modal('hide');
                        window.location.href = '@Url.Action("Index", "CredentialApproval")';
                    },
                    error: function (xhr) {
                        window.location.href = '@Url.Action("Index", "CredentialApproval")';
                    }
                });
            });
        });

    </script>
}


@* approve credential modal *@
<!-- Centered and Light-themed Modal -->
@* <div class="modal fade" id="approveModal" tabindex="-1" role="dialog" aria-labelledby="approveModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <!-- Use modal-dialog-centered -->
        <div class="modal-content" style="border-radius: 12px; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08); border: none;">


                <h4 class="modal-title w-100 text-center" id="approveModalLabel" style="font-weight: 600; color: #333;">
                    Note
                </h4>


            <div class="modal-body" style="padding: 24px; font-size: 16px; color: #555; background-color: #fff;">
                <ul style="padding-left: 0; list-style: none; margin: 0;">
                    <li>Upon Approval, the credential will be activated and published for all subscribers. Do you wish to proceed?</li>
                </ul>
            </div>

            <div class="modal-footer" style="background-color: #f9f9f9; padding: 12px 20px;">
                <button type="button" id="approveButton" class="btn" style="background-color: blue; color: white; padding: 8px 20px; border-radius: 8px; font-weight: 500;">
                    Approve
                </button>
                <button type="button" class="btn" data-dismiss="modal" style="background-color: #e0e0e0; color: #333; padding: 8px 20px; border-radius: 8px;">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>
 *@


<script>
    function showApprovalModal() {
        swal({
            title: "Note",
            text: "Upon Approval, the credential will be activated and published for all subscribers. Do you wish to proceed?",
            type: "info", // This works with older SweetAlert versions that support 'type'
            showCancelButton: true,
            confirmButtonColor: "#3085d6",
            confirmButtonText: "Approve",
            cancelButtonText: "Cancel",
            closeOnConfirm: false,
            closeOnCancel: true
        }, function (isConfirm) {
            if (isConfirm) {
                approveCredential();
            } else {
                return false;
            }
        });
    }

    function approveCredential() {
        var credentialUid = '@Model.credentialUId'; // Razor syntax

        $.ajax({
            type: 'POST',
            url: '@Url.Action("Approve", "CredentialApproval")',
            data: { uid: credentialUid },
            beforeSend: function () {
                $('#overlay').show();
            },
            complete: function () {
                $('#overlay').hide();
            },
            success: function () {
                window.location.href = '@Url.Action("Index", "CredentialApproval")';
            },
            error: function () {
                window.location.href = '@Url.Action("Index", "CredentialApproval")';
            }
        });
    }
</script>



@* reject modal *@
<div class="modal fade" id="rejectModal" tabindex="-1" role="dialog" aria-labelledby="rejectModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="rejectModalLabel">Reject Credential</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="rejectForm">
                    <div class="form-group">
                        <label for="rejectRemarks">Remarks</label>
                        <textarea id="rejectRemarks" class="form-control" rows="4" required></textarea>
                    </div>
                    <div class="text-right">
                        <button type="submit" class="btn btn-primary">Submit</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@* remarks modal *@
<div class="modal fade" id="remarksModal" tabindex="-1" role="dialog" aria-labelledby="remarksModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="remarksModalLabel">View Remarks</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                @if (!string.IsNullOrEmpty(Model.remarks))
                {
                    <p class="text-left">@Model.remarks</p>
                }
                else
                {
                    <p>No remarks available.</p>
                }
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@* Credential preview modal *@
<!-- PDF Preview Modal -->
<div id="pdfPreviewModal" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">PDF Preview</h5>
            </div>
            <div class="modal-body text-center">
                <!-- Loader -->
                <div id="pdfLoader" style="display: none;">
                    <img src="loader.gif" alt="Loading..." style="width: 50px; height: 50px;">
                    <p>Loading PDF, please wait...</p>
                </div>

                <!-- PDF Canvas -->
                <canvas id="pdfCanvas" style="width: 100%; display: none;"></canvas>
            </div>
            <div class="text-right">
                <button type="button" class="btn btn-secondary p-2 m-2" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>