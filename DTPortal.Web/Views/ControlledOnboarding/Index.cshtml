@model DTPortal.Web.ViewModel.ControlledOnboarding.ControlledOnboardingIndexViewModel

@{
    ViewData["Title"] = "Controlled Onboarding";
}

<div class="row">
    <div class="col-md-12">
        <div class="card" style="height: 70px;z-index:1;">
            <div class="form-row" style="margin-top: 4px;">
                <div class="form-group col-md-5">
                    <div class="custom-file" style="width:92%">
                        <input type="file" asp-for="TrustedUsersList" class="form-control custom-file-input" accept=".csv">
                        <label class="custom-file-label">Choose File...</label>
                        <span asp-validation-for="TrustedUsersList" class="text-danger"></span>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="btn-group">
                        <a class="btn btn-info" onclick="submitFile();"></i>Submit</a>
                        &nbsp;&nbsp;
                        <a class="btn btn-info" href="@Url.Action("DownloadCSV", "ControlledOnboarding")">Download Template</a>
                    </div>
                    &nbsp;&nbsp;
                    @*<div class="btn-group">
                        <a class="btn btn-info" asp-action="Search" asp-controller="ControlledOnboarding"></i>Search</a>
                    </div>*@
                </div>
            </div>
        </div>
    </div>
</div>
<div id="csvData">
    <div class="row">
        <div class="col-md-12">
            <div class="card-custom">
                <div class="card-body">
                    <table id="userList" class="table table-striped table-bordered" cellspacing="0" width="100%">
                        <thead>
                            <tr>
                                <th width="33.33%">Name</th>
                                <th width="33.33%">Email</th>
                                <th width="33.33%">Mobile Number</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
    var table;
    var allowedCSVFileTypes = ['.csv'];
    var emailRegex = /^([\w-\.]+)@@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.)|(([\w-]+\.)+))([a-zA-Z]{2,4}|[0-9]{1,3})(\]?)$/;

    $(document).ready(function () {
        $('#registrationAuthorityMenu').addClass('active');

        if ($('#sidebar ul li.dropdown.active')) {
            $('#sidebar ul li.dropdown.active ul').addClass('show');
            $('#controlledOnboardingMenuItem').addClass('active');
            $('#sidebar ul li.dropdown.active a.nav-link.drop-logo').attr('aria-expanded', 'true');
        }

        /*For Beadcrum Start*/
        $('#homeMenu').addClass('breadcrumb-item').append('Registration Authority');
        $('#mainMenu').addClass('breadcrumb-item active').append('Controlled Onboarding');
        $('#subMenu').removeClass('breadcrumb-item');
        /*For Beadcrum End*/

        table = $('#userList').DataTable();

        $("#csvData").hide();

        $(document).on("change", '#TrustedUsersList', function () {
            table.clear().draw();
            var file = $(this).get(0).files[0];
            if (file == undefined) {
                fileName = "Choose File...";
            }
            else {
                fileName = file.name;
                var fileExtension = getExtension(file.name);
                if (allowedCSVFileTypes.includes(fileExtension)) {
                    var reader = new FileReader();

                    reader.onload = function (e) {
                        $("#csvData").show();

                        var name;
                        var email;
                        var mobileNumber;
                        var validData = true;

                        var rows = e.target.result.split("\n");;

                        for (var i = 1; i < rows.length; i++) {
                            var cells = rows[i].replace("\r", "").split(",");

                            if (cells.length == 3) {
                                name = cells[0];
                                email = cells[1];
                                mobileNumber = cells[2];
                                if (email == "" || !emailRegex.test(email)) {
                                    validData = false;
                                    break;
                                }

                                if (mobileNumber.length >= 13 || mobileNumber.match(/[^+0-9]/g)) {
                                    validData = false;
                                    break;
                                }

                                if (name == "") {
                                    validData = false;
                                    break;
                                }
                                if (validData) {
                                    table.row.add(cells).draw();
                                }
                            }
                        }
                        if (!validData) {
                            table.clear().draw();
                            fileName = "Choose File...";
                            $('.custom-file-label').html(fileName);
                            if (email == "" || !emailRegex.test(email)) {
                                swal({ type: 'error', title: "Invalid Email", text: email + " is invalid email." });
                            }
                            else if (mobileNumber.length >= 13 || mobileNumber.match(/[^+0-9]/g)) {
                                swal({ type: 'error', title: "Invalid Mobile Number", text: mobileNumber + " is invalid mobile number." });
                            }
                            else if (name == "") {
                                swal({ type: 'error', title: "Invalid Name", text: "Name cannot be null" });
                            }
                        }
                        $('#TrustedUsersList').val('');
                    }
                    reader.readAsText($("#TrustedUsersList")[0].files[0]);
                }
                else {
                    swal({ type: 'error', title: "File Not Supported", text: "Files with extensions: " + allowedCSVFileTypes.join(',') + " are only supported" });
                }
            }
            $(this).next('.custom-file-label').html(fileName);
        });
    });

    function submitFile() {

        //table.rows({search : "applied"}).data().toArray();

        $('#userList').DataTable().rows().iterator('row', function (context, index) {
            var node = $(this.row(index).node());
        });

        var trustedUserList = tableData();

        //var dataToSend = tableToJSON($("#userList"));

        var data = JSON.stringify({ UserList: trustedUserList });

        //if (dataToSend[0].Name == "No data available in table") {
        //    swal({ type: 'error', title: "Failed", text: "Please upload file" });
        //}
        if (trustedUserList.length == 0) {
            swal({ type: 'error', title: "Failed", text: "Please upload file" });
        }
        else {
            $.ajax({
                url: '@Url.Action("AddTrustedUsers", "ControlledOnboarding")',
                data: data,
                type: "POST",
                // contentType: "json",
                contentType: "application/json",
                error: ajaxErrorHandler,
                beforeSend: function () {
                    $('#overlay').show();
                },
                complete: function () {
                    $('#overlay').hide();
                },
                success: function (data) {
                    if (data != null) {
                        if (data.status == "Success") {
                            swal({ type: 'success', title: "Success", text: data.message }, function (isConfirm) {
                                $("#csvData").hide();
                                window.location.reload();
                            });
                        }
                        else {
                            if (typeof data == "object") {
                                swal({ type: 'error', title: "Failed", text: data.message }, function (isConfirm) {
                                    $("#csvData").hide();
                                    window.location.reload();
                                });
                            }
                            else {
                                $('#modalDialogContentDiv').html(data);
                                $('#modalDialogDiv').modal('show');
                            }
                        }
                    }
                    else {
                        swal({ type: 'error', title: "Failed", text: "Failed to add trusted users" }, function (isConfirm) {
                            $("#csvData").hide();
                            window.location.reload();
                        });
                    }
                }
            });
        }


    }

    function tableData() {
        var list = [];
        var data = $('#userList').DataTable().rows().data();

        for (var i = 0; i < data.length; i++) {
            var obj = {
                "Name": data[i][0],
                "Email": data[i][1],
                "MobileNo": data[i][2]
            }
            list.push(obj);
        }
        return list;
    }

    function getExtension(filename) {
        return '.' + filename.split('.').pop().toLowerCase();
    }

    function tableToJSON(tblObj) {
        var keyToSend = {
            "Name": "FullName",
            "Email": "EmailId",
            "Mobile Number": "MobileNumber"
        }
        var data = [];
        var $headers = $(tblObj).find("th");
        var $rows = $(tblObj).find("tbody tr").each(function (index) {
            $cells = $(this).find("td");
            data[index] = {};
            $cells.each(function (cellIndex) {
                //var key = ($headers[cellIndex]).innerHTML;
                //data[index][keyToSend[key]] = $(this).html();
                //data[index][($headers[cellIndex]).html().replace(" ","")] = $(this).html();
                data[index][$($headers[cellIndex]).html().replace(' ', "")] = $(this).html();
            });
        });
        return data;
    }
</script>