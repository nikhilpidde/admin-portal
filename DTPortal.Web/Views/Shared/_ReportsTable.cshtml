@model PaginatedList<DTPortal.Core.DTOs.LogReportDTO>
@using DTPortal.Core
@using System

<div class="col-md-12 mt-5">
    <div class="card-custom">
        <div class="card-body">
            <div class="row p-b-20">
                <div class="col-md-6 col-sm-6 col-6">
                    <div class="btn-group">
                        <h3 class="card-title" style="color:black">REPORTS</h3>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    </div>
                </div>
                <div class="col-md-6 col-sm-6 col-6">
                    <form method="post" asp-action="Export">
                        <div class="d-flex justify-content-end">
                            <button class="btn btn-info" id="exportReport" type="submit">
                                Export&nbsp;<i class="fa fa-file-pdf-o"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div style="background-color:transparent">
                <table class="table table-responsive table-striped table-bordered table-hover table-checkable order-column">
                    <thead>
                        <tr>
                            <th>Subscriber Identifier</th>
                            <th>Operation</th>
                            <th>Log Message</th>
                            <th>Status</th>
                            <th>Start Time</th>
                            <th>End Time</th>
                            <th>Integrity Check</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.Count() > 0)
                        {
                            @foreach (var item in Model)
                            {
                                <tr class="odd gradeX">
                                    <td>@item.Identifier</td>
                                    <td>@item.ServiceName</td>
                                    <td>@item.LogMessage</td>
                                    <td>@item.LogMessageType</td>
                                    <td hidden>@item.TransactionType</td>
                                    <td>@(Convert.ToDateTime(item.StartTime).ToString("dd-MM-yyyy hh:mm:ss tt"))</td>
                                    <td>@(Convert.ToDateTime(item.EndTime).ToString("dd-MM-yyyy hh:mm:ss tt"))</td>
                                    <td hidden>@item.CorrelationID</td>
                                    <td hidden>@item.TransactionID</td>
                                    <td hidden>@item.SubTransactionID</td>
                                    <td hidden>@item.GeoLocation</td>
                                    <td hidden>@item.TransactionSubType</td>
                                    <td hidden>@item.ServiceProviderName</td>
                                    <td hidden>@item.ServiceProviderAppName</td>
                                    <td hidden>@item.SignatureType</td>
                                    <td hidden>@item.ESealUsed</td>
                                    <td hidden>@item.CallStack</td>
                                    <td hidden>@item.Checksum</td>
                                    <td hidden>@item.Timestamp</td>
                                    <td hidden>@item.__v</td>
                                    <td hidden>@item._id</td>
                                    <td hidden>@item.StartTime</td>
                                    <td hidden>@item.EndTime</td>
                                    <td>
                                        <div class="text-center">
                                            <input class="btn btn-primary" type="button" value="Verify" />
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="8" align="center" style="width:200%">No records found</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            <div>
                @{ var prevDisabled = !Model.HasPreviousPage ? "disabled" : "";
                    var nextDisabled = !Model.HasNextPage ? "disabled" : ""; }

                <div class="row">
                    <div class="col-sm-12 col-md-5">
                        <div class="dataTables_info" id="dtHorizontalVerticalExample_info" style="margin-top: 1rem;" role="status" aria-live="polite">
                            @{ var i = 100 - (100 - (Model.PageSize * (Model.PageIndex - 1))) + 1;
                                var j = i + Model.Count - 1;
                                var k = Model.TotalCount; }
                            Showing @i to @j of @k
                        </div>
                    </div>
                    <div class="col-sm-12 col-md-7 paginationStyle">
                        <div class="dataTables_paginate paging_simple_numbers" id="example4_paginate">
                            <ul class="pagination">
                                <li class="paginate_button page-item previous @prevDisabled" id="example4_previous">
                                    <a aria-controls="example4" data-dt-idx="0" tabindex="0" class="page-link" asp-action="ReportsByPage" asp-route-page="@(Model.PageIndex - 1)">Previous</a>
                                </li>
                                @{ int count = -2;
                                    while (count <= 2)
                                    {
                                        var index = Model.PageIndex + count;

                                        if (index > 0 && index < Model.TotalPages)
                                        {
                                            if (index == Model.PageIndex)
                                            {
                                                <li class="paginate_button page-item active">
                                                    <a aria-controls="example4" data-dt-idx="1" tabindex="0" class="page-link" asp-action="ReportsByPage" asp-route-page="@index">@index</a>
                                                </li>
                                            }
                                            else
                                            {
                                                <li class="paginate_button page-item">
                                                    <a aria-controls="example4" data-dt-idx="1" tabindex="0" class="page-link" asp-action="ReportsByPage" asp-route-page="@index">@index</a>
                                                </li>
                                            }
                                        }
                                        count++;
                                    } }
                                <li class="paginate_button page-item next @nextDisabled" id="complex_header_next">
                                    <a aria-controls="example4" data-dt-idx="0" tabindex="0" class="page-link" asp-action="ReportsByPage" asp-route-page="@(Model.PageIndex + 1)">Next</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {

        $('table').on('click', 'input[value="Verify"]', function () {
            var row = $(this).closest('tr');
            var logReport = {};
            logReport.identifier = row.find('td:eq(0)').text();
            logReport.serviceName = row.find('td:eq(1)').text();
            logReport.logMessage = row.find('td:eq(2)').text();
            logReport.logMessageType = row.find('td:eq(3)').text();
            logReport.transactionType = row.find('td:eq(4)').text();
            logReport.startTime = row.find('td:eq(21)').text();
            logReport.endTime = row.find('td:eq(22)').text();
            logReport.correlationID = row.find('td:eq(7)').text();
            logReport.transactionID = row.find('td:eq(8)').text();
            logReport.subTransactionID = row.find('td:eq(9)').text() == '' ? null : row.find('td:eq(9)').text();
            logReport.geoLocation = row.find('td:eq(10)').text() == '' ? null : row.find('td:eq(10)').text();
            logReport.transactionSubType = row.find('td:eq(11)').text() == '' ? null : row.find('td:eq(11)').text();
            logReport.serviceProviderName = row.find('td:eq(12)').text() == '' ? null : row.find('td:eq(12)').text();
            logReport.serviceProviderAppName = row.find('td:eq(13)').text() == '' ? null : row.find('td:eq(13)').text();
            logReport.signatureType = row.find('td:eq(14)').text() == '' ? null : row.find('td:eq(14)').text();
            logReport.eSealUsed = (row.find('td:eq(15)').text() == "true") ? true : false;
            logReport.callStack = row.find('td:eq(16)').text() == '' ? null : row.find('td:eq(16)').text();
            logReport.checksum = row.find('td:eq(17)').text();
            logReport.timestamp = row.find('td:eq(18)').text();
            logReport.__v = row.find('td:eq(19)').text();
            logReport._id = row.find('td:eq(20)').text();

            $.ajax({
                type: "POST",
                url: '@Url.Action("VerifyChecksum", "Reports")',
                data: JSON.stringify(logReport),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                beforeSend: function () {
                    $('#overlay').hide();
                },
                complete: function () {
                    $('#overlay').hide();
                }
            }).done(function (response) {
                var type;
                var text;
                //alert(response.message);
                if (response.status == "Success") {
                    type = 'success';
                    text = response.message;
                }
                else {
                    type = 'error';
                    text = response.message;
                }
                swal({ type: type, title: "Integrity Check", text: text });
            });
        });

        function GetDateFormat(dateString) {
            var d1 = Date.parse(dateString.replace(/([0-9]+)\/([0-9]+)/, '$2/$1'));
            if (d1 == null) {
                alert('Date Invalid.');
                $('#' + controlName).val("");
            }
            var array = d1.toString('dd-MMM-yyyy');
            $('#' + controlName).val(array);
        }

        //if ($('table tbody tr td:last-child input[type=button]').length == 0) {
        //    $('#exportReport').attr('disabled', true);
        //}
    });
</script>

<style>
    thead, tbody tr {
        display: table;
        width: 120%;
        table-layout: fixed;
        text-align: left;
    }

    thead {
        width: calc( 120% - 0em )
    }

    tr td {
        overflow-x: hidden;
        overflow-y: hidden;
        font-size: 12px;
        word-wrap: break-word;
    }
</style>