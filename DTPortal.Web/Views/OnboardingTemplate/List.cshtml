@model DTPortal.Web.ViewModel.OnboardingTemplate.OnbaordingTemplateListViewModel
@using DTPortal.Web.Enums
@using DTPortal.Web.ExtensionMethods

@{
    ViewData["Title"] = "Onboarding Templates";
}

@{
    await Html.RenderPartialAsync("_AlertBox");
}

<!--TABLE CONTENT START-->
<div class="row">
    <div class="col-md-12">
        <div class="card ">
            <div class="card-body ">
                <div class="row p-b-20">
                    <div class="col-md-6 col-sm-6 col-6">
                        @if (!User.IsInRole("Template Management Checker"))
                        {
                            <div class="btn-group">
                                <a class="btn btn-info" asp-action="Add">
                                    <i class="fa fa-plus"></i>Add
                                </a>
                            </div>
                        }
                        <div class="btn-group">
                            <a class="btn btn-info" asp-action="List">
                                <i class="fa fa-refresh"></i>Refresh
                            </a>
                        </div>
                    </div>

                </div>
                @* <div class="table-wrap">
                    <div class="table-responsive"> *@
                <table class="table table-striped table-bordered table-hover table-checkable order-column full-width">
                    <thead>
                        <tr>
                            <th hidden>Id</th>
                            <th>Template</th>
                            <th>Method</th>
                            <th>Published Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model.Templates)
                        {
                            <tr class="odd gradeX">
                                <td hidden>@item.TemplateId</td>
                                <td>@item.TemplateName</td>
                                <td>@item.TemplateMethod</td>
                                <td>@item.PublishedStatus</td>
                                <td class="valigntop" align="center">
                                    @if (!User.IsInRole("Template Management Checker"))
                                    {
                                        <div class="btn-group">
                                            <button class="btn btn-xs deepPink-bgcolor no-margin" type="button" data-toggle="dropdown"
                                            aria-expanded="false">
                                                Actions
                                                <i class="fa fa-angle-down"></i>
                                            </button>
                                            <ul class="dropdown-menu pull-left" role="menu">
                                                <li>
                                                    <a asp-action="Edit" asp-route-id="@item.TemplateId">
                                                        <i class="icon-pencil"></i>Edit
                                                    </a>
                                                </li>
                                                @if (item.PublishedStatus.ToLower() == PublishStatus.Published.GetValue().ToLower())
                                                {
                                                    <li>
                                                        <a class="js-unpublish" data-id="@item.TemplateId">
                                                            <i class="icon-docs"></i>Unpublish
                                                        </a>
                                                    </li>
                                                }
                                                else if (item.PublishedStatus.ToLower() == PublishStatus.Unpublished.GetValue().ToLower())
                                                {
                                                    <li>
                                                        <a class="js-publish" data-id="@item.TemplateId">
                                                            <i class="icon-docs"></i>Publish
                                                        </a>
                                                    </li>
                                                }
                                            </ul>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="btn-group">
                                            <button class="btn btn-xs deepPink-bgcolor no-margin" type="button" data-toggle="dropdown"
                                            aria-expanded="false">
                                                Actions
                                                <i class="fa fa-angle-down"></i>
                                            </button>
                                            <ul class="dropdown-menu pull-left" role="menu">
                                                <li>
                                                    <a asp-action="Edit" asp-route-id="@item.TemplateId">
                                                        <i class="icon-pencil"></i>View
                                                    </a>
                                                </li>
                                            </ul>
                                        </div>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            @* </div>
            </div> *@
            </div>
        </div>
    </div>
</div>

<!--TABLE CONTENT END-->
@section scripts{
<script>
    $(document).ready(function () {
        $('#registrationAuthorityMenu').addClass('active');

        if ($('#sidebar ul li.dropdown.active')) {
            $('#sidebar ul li.dropdown.active ul').addClass('show');
            $('#onboardingTemplatesMenuItem').addClass('active');
            $('#sidebar ul li.dropdown.active a.nav-link.drop-logo').attr('aria-expanded', 'true');
        }

            // $(function () {
            //     window.addEventListener('resize', function () {
            //         const width = window.innerWidth;
            //         let sidebarWidth = $('#sidebar').width();
            //         $('.table').css('width', width - sidebarWidth);
            //     });
            // });

        /*For Beadcrum Start*/
        $('#homeMenu').addClass('breadcrumb-item').append('Registration Authority');
        $('#mainMenu').addClass('breadcrumb-item active').append('Templates');
        $('#subMenu').addClass('breadcrumb-item').append('List');
        /*For Beadcrum End*/

        $(".table").DataTable({
            "bLengthChange": false,
            "ordering": true,
            "order": [[0, "desc"]]
        });

         $(".table").on('click', '.js-publish', function () {
                var enableButton = $(this);
                 var id = enableButton.attr("data-id");
                swal({
                    title: "Are you sure?",
                    text: "Publishing this template",
                    type: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#DD6B55",
                    confirmButtonText: "Yes",
                    cancelButtonText: "No",
                    closeOnConfirm: true,
                    closeOnCancel: true
                }, function (isConfirm) {
                    if (isConfirm) {
                        $.ajax({
                            type: 'POST',
                            cache: false,
                            url: '@Url.Action("Publish", "OnboardingTemplate")',
                            headers: {
                                "XSRF-TOKEN": $('input[name="__RequestVerificationToken"]').val()
                            },
                            data: { id: id, },
                            beforeSend: function () {
                                $('#overlay').show();
                            },
                            complete: function () {
                                $('#overlay').hide();
                            }
                        }).done(function (response) {
                            if (response.status == "Success") {
                                type = 'success';
                                text = response.message;
                            }
                            else {
                                type = 'error';
                                text = response.message;
                            }
                            swal({ type: type, title: response.title, text: text }, function (isConfirm) {
                                if (isConfirm) {
                                    if (type == 'success') {
                                        window.location.reload();
                                    }
                                }
                            });
                        }).fail(ajaxErrorHandler)
                    }
                });
             });

            $(".table").on('click', '.js-unpublish', function () {
                var disableButton = $(this);
                var id = disableButton.attr("data-id");
                swal({
                    title: "Are you sure?",
                    text: "Unpublishing this template",
                    type: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#DD6B55",
                    confirmButtonText: "Yes",
                    cancelButtonText: "No",
                    closeOnConfirm: true,
                    closeOnCancel: true
                }, function (isConfirm) {
                    if (isConfirm) {
                        $.ajax({
                            type: 'POST',
                            cache: false,
                            url: '@Url.Action("Unpublish", "OnboardingTemplate")',
                            headers: {
                                "XSRF-TOKEN": $('input[name="__RequestVerificationToken"]').val()
                            },
                            data: { id: id, },
                            beforeSend: function () {
                                $('#overlay').show();
                            },
                            complete: function () {
                                $('#overlay').hide();
                            }
                        }).done(function (response) {
                            if (response.status == "Success") {
                                type = 'success';
                                text = response.message;
                            }
                            else {
                                type = 'error';
                                text = response.message;
                            }
                            swal({ type: type, title: response.title, text: text }, function (isConfirm) {
                                if (isConfirm) {
                                    if (type == 'success') {
                                        window.location.reload();
                                    }
                                }
                            });
                        }).fail(ajaxErrorHandler)
                    }
                });
            });

        $(".table").on('click', '.js-delete', function () {
            var deleteButton = $(this);
            var id = deleteButton.attr("data-id");
            swal({
                title: "Are you sure?",
                text: "Do you want to delete this template?",
                type: "warning",
                showCancelButton: true,
                confirmButtonColor: "#DD6B55",
                confirmButtonText: "Yes",
                cancelButtonText: "No",
                closeOnConfirm: true,
                closeOnCancel: true
            }, function (isConfirm) {
                if (isConfirm) {
                    $.ajax({
                        type: 'POST',
                        cache: false,
                        url: '@Url.Action("Delete", "OnboardingTemplate")',
                        headers: {
                            "XSRF-TOKEN": $('input[name="__RequestVerificationToken"]').val()
                        },
                        data: { id: id, },
                        beforeSend: function () {
                            $('#overlay').show();
                        },
                        complete: function () {
                            $('#overlay').hide();
                        }
                    }).done(function (response) {
                        if (response.status == "Success") {
                            type = 'success';
                            text = response.message;
                        }
                        else {
                            type = 'error';
                            text = response.message;
                        }
                        swal({ type: type, title: response.title, text: text }, function (isConfirm) {
                            if (isConfirm) {
                                if (type == 'success') {
                                    deleteButton.closest('tr').remove();
                                    window.location.reload();
                                }
                            }
                        });
                    }).fail(ajaxErrorHandler)
                }
            });
        });
    });
</script>
}

