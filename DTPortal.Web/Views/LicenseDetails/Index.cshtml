@model DTPortal.Web.ViewModel.LicenseDetails.LicenseDetailsViewModel
@using Newtonsoft.Json
@using System.Globalization

@{
    ViewData["Title"] = "Certificate Details";
}

<style>
    .header {
        text-align: center;
        color: green;
        padding-bottom: 35px;
    }

    table {
        width: 55%;
        border-collapse: collapse;
    }

    td, th {
        border: 1px solid gray;
        padding: 9px;
        font-size: 14px;
        text-align: center;
    }

    table th {
        background-color: #AEC737;
        color: white;
    }

    .heading {
        width: 450px;
    }
</style>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <div class="row p-b-20">
                    <div class="col-md-6 col-sm-6 col-6">
                        <div class="btn-group">
                            <a class="btn btn-info" asp-action="Index">
                                <i class="fa fa-refresh"></i>Refresh
                            </a>
                        </div>
                    </div>
                </div>
                <div>
                    <table align='center'>
                        <tr>
                            <th colspan="2" style="text-align:left">Subscribers Certificate Details</th>
                        </tr>
                        <tr>
                            <td class="heading">Total Certificates</td>
                            <td>@Model.TotalSubscribersCertificates</td>
                        </tr>
                        <tr>
                            <td class="heading">Certificates Issued</td>
                            <td>@Model.SubscribersCertificatesIssued</td>
                        </tr>
                        <tr>
                            <td class="heading">Certificates Available</td>
                            <td>@Model.SubscribersCertificatesAvailable</td>
                        </tr>
                    </table>
                    <div class="d-flex justify-content-end ">
                        <button type="button" class="btn btn-primary" onclick="generatePdf()">Generate PDF</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts
{
    @{
    await Html.RenderPartialAsync("_ValidationScriptsPartial");
 }

<script>
        $(document).ready(function () {
            $('#portalSettingsMenu').addClass('active');

            if ($('#sidebar ul li.dropdown.active')) {
                $('#sidebar ul li.dropdown.active ul').addClass('show');
                $('#certificatesMenuItem').addClass('active');
                $('#licenseDetailsSidebarElement').addClass('active');
                $('#sidebar ul li.dropdown.active a.nav-link.drop-logo').attr('aria-expanded', 'true');
            }

            /*For Beadcrum Start*/
            $('#homeMenu').addClass('breadcrumb-item').append('Portal Settings');
            $('#mainMenu').addClass('breadcrumb-item active').append('Certificate');
            $('#subMenu').addClass('breadcrumb-item active').append('Certificate Details');
            /*For Beadcrum End*/
        });

    function generatePdf() {
        $.ajax({
            type: "POST",
            headers: {
                "XSRF-TOKEN": $('input[name="__RequestVerificationToken"]').val()
            },
            url: '@Url.Action("GetPDFBytes", "LicenseDetails")',
            data: '@Html.Raw(Json.Serialize(Model))',
            contentType: 'application/json',
            dataType: "json",
            error: ajaxErrorHandler,
            beforeSend: function () {
                $('#overlay').show();
            },
            complete: function () {
                $('#overlay').hide();
            },
            success: function (data) {
                if (data.status == "Success") {
                    saveByteArray("LicenseDetails", data.result)
                }
                if (data.status == "Failed") {
                    swal({ type: 'error', title: "Error", text: data.message });
                }
            }
        });
    }

        function saveByteArray(name, bytes) {
            var myBytes = base64ToArrayBuffer(bytes);
            var blob = new Blob([myBytes], { type: "application/pdf" });
            var link = document.createElement('a');
            link.href = window.URL.createObjectURL(blob);
            let fileName = name + ".pdf";
            link.download = fileName;
            link.click();
        }

        function base64ToArrayBuffer(base64) {
            var binaryString = window.atob(base64);
            var binaryLen = binaryString.length;
            var bytes = new Uint8Array(binaryLen);
            for (var i = 0; i < binaryLen; i++) {
                var ascii = binaryString.charCodeAt(i);
                bytes[i] = ascii;
            }
            return bytes;
        }
</script>
}