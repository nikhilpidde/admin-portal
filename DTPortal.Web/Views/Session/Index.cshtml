@model DTPortal.Web.ViewModel.Session.SessionViewModel
@using System.Security.Claims;

@{
    ViewData["Title"] = "Session";
}

@{
    await Html.RenderPartialAsync("_AlertBox");
}

@{

    var UserName = (@Model.HasData ? @Model.SessionDetails.FullName : "");
    var UserId = (@Model.HasData ? @Model.SessionDetails.UserId : "");
    var currentUserName = @User.Claims.FirstOrDefault(c => c.Type == ClaimTypes.Name).Value;
    var currentUserId = @User.Claims.FirstOrDefault(c => c.Type == ClaimTypes.NameIdentifier).Value;
    var allowDelete = (UserName == currentUserName && UserId == currentUserId ? false : true);

}

<div class="row">

    <div class="col-md-12">
        <div class="card-custom">
            <!-- <div class="card-header">
                <h5 class="card-title">Form row</h5>
                <h6 class="card-subtitle text-muted">Bootstrap column layout.</h6>
            </div> -->
            <div class="card-body">
                <form asp-action="Index">
                    <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                    <div class="form-row">
                        <div class="form-group col-md-4">
                            <label class="col-form-label" for="inputPassword4">Search By</label>
                            @if (Model.SessionType == "user")
                            {
                                <select asp-for="SearchType" class="form-control"
                                    asp-items="Model.UserSearchTypeList">
                                    <option value="">--Select--</option>
                                </select>
                            }
                            else
                            {
                                <select asp-for="SearchType" class="form-control"
                                    asp-items="Model.RASearchTypeList">
                                    <option value="">--Select--</option>
                                </select>
                            }
                            <span asp-validation-for="SearchType" class="text-danger"></span>
                        </div>
                        <div class="form-group col-md-5">
                            <label class="col-form-label" for="enterValue">Enter Value</label>
                            <input class="form-control" asp-for="SearchValue" placeholder="Enter Value">
                            <input class="form-control" asp-for="SessionType" type="hidden">
                            <span asp-validation-for="SearchValue" class="text-danger"></span>
                        </div>
                        <div style="margin-top: 35px;">
                            <button type="submit" class="btn btn-primary">
                                Search
                            </button>&nbsp;&nbsp;
                            <a type="button" value="Reset" asp-action="Index" asp-route-id="@Model.SessionType" class="btn btn-danger">
                                Reset
                            </a>@*&nbsp;&nbsp;
                                <a type="button" asp-action="List" class="btn btn-info">
                                View All
                                </a>*@
                        </div>
                    </div>
                </form>
            </div>

            @if (Model.HasData)
            {
                <div id="modal_subscriber_data">
                    <div class="card-header">

                        <h5 class="card-title">

                            @(Model.SessionType == "user" ? "User" : "Subscriber") Session Details

                        </h5>
                    </div>

                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <div class="form-group">
                                    <label class="col-form-label s3">@(Model.SessionType == "user" ?"UUID":"SUID")</label>
                                    <input asp-for="SessionDetails.UserId" class="form-control" readonly />
                                </div>
                                <div class="form-group">
                                    <label class="col-form-label s3">Name</label>
                                    <input asp-for="SessionDetails.FullName" class="form-control" readonly />
                                </div>
                                <div class="form-group">
                                    <label class="col-form-label s3">Logged In Time</label>
                                    <input asp-for="SessionDetails.LoggedInTime" class="form-control" readonly />
                                </div>
                                @*<div class="form-group">
                                    <label class="col-form-label s3">Last Access Time</label>
                                    <input asp-for="SessionDetails.LastAccessTime" class="form-control" readonly />
                                    </div>*@
                                <div class="form-group">
                                    <label class="col-form-label s3">Type Of Device</label>
                                    <input asp-for="SessionDetails.TypeOfDevice" class="form-control" style="text-transform: capitalize;" readonly />
                                </div>
                            </div>
                            <div class="form-group col-md-6">
                                <div class="form-group">
                                    <label class="col-form-label s3">Ip Address</label>
                                    <input asp-for="SessionDetails.IpAddress" class="form-control" readonly />
                                </div>
                                @*<div class="form-group">
                                    <label class="col-form-label s3">Mac Address</label>
                                    <input asp-for="SessionDetails.MacAddress" class="form-control" />
                                    </div>*@
                                <div class="form-group">
                                    <label class="col-form-label s3">User Agent Details</label>
                                    <input asp-for="SessionDetails.UserAgentDetails" class="form-control" readonly />
                                </div>

                                <div class="form-group">
                                    <label class="col-form-label s3">Applications</label>
                                    <select class="form-control multiple-select" multiple="multiple" size="@Model.SessionDetails.Clientlist.Count.ToString()"
                                        asp-items="Model.SessionDetails.Clientlist">
                                    </select>
                                </div>
                                @*<div class="form-group">
                                    <label class="col-form-label s3">Authentication Scheme</label>
                                    <input asp-for="SessionDetails[0].AuthenticationScheme" class="form-control" />
                                    </div>*@
                            </div>
                        </div>
                        <div style="padding-right: 10px">

                            <div class="d-flex justify-content-end ">
                                <button class="btn btn-primary js-delete" type="button" data-Name="@Model.SessionDetails.FullName" data-id="@Model.SessionDetails.GlobalSessionId">Logout</button>

                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>


<link href="~/global_assets/autoComplete/css/autoComplete2.css" rel="stylesheet" type="text/css" />
<style>
    select[multiple], select[size] {
        height: 200px;
        padding: 5px;
    }

        select[multiple] option, select[size] option {
            padding: .5rem 1rem;
            border-radius: .1875rem;
            border: 1px solid #80808024;
            background-color: #e4dede24;
        }

    .multiple-select {
        display: block !important;
        width: 100% !important;
        height: auto;
        max-height: 7.3999rem !important;
        padding: 0.375rem 1rem;
        line-height: 1.52857;
        color: #495057;
        background-color: #fff;
        background-clip: padding-box;
        border: 1px solid #dde6e9;
        border-radius: 0.25rem;
        box-shadow: 0 0 0 #000 !important;
        font-size: 0.875rem;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
</style>
@section scripts{
    @{
    await Html.RenderPartialAsync("_ValidationScriptsPartial");
}
<script src="~/assets/js/bootstrap3-typeahead.min.js"></script>
<script>
    var table = "";
    $(document).ready(function () {

        let SessionType ='@Model.SessionType';


                 if (SessionType == "user"){
                        $('#administrationSidebarElement').addClass('active');
                        $('#adminSubmenu').addClass('show');
                        $('#UserSessionSidebarElement').addClass('active');
                        $("li#administrationSidebarElement a:first").attr('aria-expanded', 'true');
                        $('#homeMenu').addClass('breadcrumb-item').append('Administration');
                        $('#mainMenu').addClass('breadcrumb-item active').append('User Session');
                        $('#subMenu').removeClass('breadcrumb-item');
                 }
                 else {
                     $('#homeSubmenu').addClass('show');
                     $("li#digitalAuthSidebarElement a:first").attr('aria-expanded', 'true');
                     $('#digitalAuthSidebarElement').addClass('active');
                     $('#RASessionSidebarElement').addClass('active');
                     $('#homeMenu').addClass('breadcrumb-item').append('Digital Authentication');
                    $('#mainMenu').addClass('breadcrumb-item active').append('Subscriber Session');
                    $('#subMenu').removeClass('breadcrumb-item');
                 }

            /*For Beadcrum Start*/



        $("#SearchType").change(function (e) {

            var placeHolder = $("#SearchValue");
            placeHolder.val("");
            placeHolder.unbind("keypress");
            $("span[data-valmsg-for='SearchValue']").html('');

            var placeHolderVal = $("#SearchType option:selected").text();

            if (placeHolderVal == "--select--")
                placeHolder.attr("placeholder", "Enter value")
            else
                placeHolder.attr("placeholder", "Enter The " + placeHolderVal + (placeHolderVal != "Email ID" && placeHolderVal != "Mobile Number" && placeHolderVal != "Card Number" ? " Number" : (placeHolderVal == "Mobile Number" ? "(+97198XX...)" : "")));


            if ($('select option:selected').val() == "1") {
                placeHolder.keypress(function (e) {
                    var charCode = (e.which) ? e.which : event.keyCode

                    if (String.fromCharCode(charCode).match(/[^+0-9]/g))

                        return false;
                });
            }
        });

        var searchURL = "";
        var placeholderObject =""
        if (SessionType == "user") {
            searchURL = '@Url.Action("GetUsers", "UserManagement")';
            placeholderObject = {
                3: "NIN",
                4: "PASSPORT",
                2: "EMAIL",
                1: "MOBILE_NUMBER",
            }
        }
        else {
            searchURL = '@Url.Action("GetSubscribers", "Subscriber")';
            //placeholderObject = {
            //    1: "1",
            //    2: "2",
            //    3: "3",
            //    4: "4",
            //}
            placeholderObject = {
                1: "4",
                2: "3",
                3: "1",
                4: "2",
            }
        }

        $("#SearchValue").typeahead({
            minLength: 5,
            items:10,
            source: function (request, response) {
                let type = $('#SearchType').val();

                if (type == "")
                    return;

                if (SessionType == "user")
                    type = placeholderObject[type.toString()]
                else
                    type = parseInt(placeholderObject[type.toString()])

                $.ajax({
                    url: searchURL,
                    data: { "type": type, "value": request },
                    type: "GET",
                    contentType: "json",
                    error: ajaxErrorHandler,
                    success: function (data) {
                        items = [];
                        map = {};
                        $.each(data, function (i, item) {
                            var id = i;
                            var name = item;
                            map[name] = {
                                id: id,
                                name: name
                            };
                            items.push(name);
                        });
                        response(items);
                    }
                });
            },
            updater: function (item) {
                return item;
            }
        });

        $('#SearchValue').on("keypress",function (e) {
                    if (identifierValue.val().length >= 13)
                    {
                        return false;
                    }
                    var charCode = (e.which) ? e.which : event.keyCode;
                    if (String.fromCharCode(charCode).match(/[^+0-9]/g))
                        return false;
                });

        $("button[type='submit']").on("click", function (e) {
            var value = $('#SearchValue');
            var emailId,mobileid;
            var selectedOption = $('select option:selected').val();
            if (SessionType == "user") {
                emailId = "2";
                mobileid = "1";
                selectedOption = placeholderObject[selectedOption.toString()]
            } else {
                emailId = "3";
                mobileid = "4";
                selectedOption = placeholderObject[selectedOption.toString()]
            }

            

                if (selectedOption == emailId && value.val() != '') {
                var emailRegex = /^([\w-\.]+)@@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.)|(([\w-]+\.)+))([a-zA-Z]{2,4}|[0-9]{1,3})(\]?)$/;
                if (!emailRegex.test(value.val())) {
                    $("span[data-valmsg-for='SearchValue']").html('Invalid email address');
                    e.preventDefault();
                }
            }

                if (selectedOption == mobileid && value.val() != '') {
                var MobileRegex = /^((\+91)\d{10}|(\+971)\d{9})$/;
                if (!MobileRegex.test(value.val())) {
                     $("span[data-valmsg-for='SearchValue']").html('Invalid mobile number');
                     e.preventDefault();
                }
            }

        });

       // $('#sessionTable').on('click', '.js-delete', function () {
        $('.js-delete').on('click', function () {
            var deleteButton = $(this);
            var id = deleteButton.attr("data-id");
            var Name = deleteButton.attr("data-Name");

            var deleteAllow = '@allowDelete';
            if (deleteAllow == "False") {
                swal({
                    title: "Not Allowed!",
                    text: "Do not have permission to self logout",
                    button: "Close", // Text on button
                    type: "info", //built in icons: success, warning, error, info
                    timer: 4000, //timeOut for auto-close
                    buttons: {
                        confirm: {
                            text: "OK",
                            value: true,
                            visible: true,
                            className: "",
                            closeModal: true
                        },
                        cancel: {
                            text: "Cancel",
                            value: false,
                            visible: true,
                            className: "",
                            closeModal: true,
                        }
                    }
                }, function (isConfirm) {
                        if (isConfirm) {
                            return true;
                    } else {
                        swal.close();
                            return true;
                    }
                });
                return true;
            }

            swal({
                title: "Are you sure!",
                text: "you want to logout this user session",
                type: "info",
                showCancelButton: true,
                confirmButtonColor: "#DD6B55",
                confirmButtonText: "Yes",
                cancelButtonText: "No",
                closeOnConfirm: false,
                closeOnCancel: true
            }, function (isConfirm) {
                if (isConfirm) {
                    $.ajax({
                        type: 'POST',
                        cache: false,
                        dataType: 'json',
                        url: '@Url.Action("Logout", "Session")',
                        data: {
                            id: id,
                            name: Name
                        },
                        beforeSend: function () {
                            $('#overlay').show();
                        },
                        complete: function () {
                            $('#overlay').hide();
                        },
                        success: function (result, status, xhr) {
                            var title, text, type = "";
                            if (result.success) {
                                title = "Success!";
                                type = "success";
                                text = "Logout successful"
                            }
                            else {
                                title = "Error!";
                                type = "error";
                                text = result.message
                            }
                            swal(title, text, type);
                            swal({
                                title: title,
                                text: text,
                                type: type,
                                showCancelButton: false,
                                confirmButtonText: "Yes",
                                closeOnConfirm: false,
                                closeOnCancel: false
                            }, function (isConfirm) {
                                    if (isConfirm)
                                    location.href = '@Url.Action("Index","Session",new { id = Model.SessionType})';
                            });
                           // table.row(deleteButton.parents("tr")).remove().draw();
                        },
                        error:ajaxErrorHandler
                    });
                } else {
                    return false
                }
            });
        });



    });



</script>
}
