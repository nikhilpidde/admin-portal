@model DTPortal.Web.ViewModel.SubscriberBalanceSheet.SubscriberBalanceSheetViewModel
@using DTPortal.Web.Enums

@{
    ViewData["Title"] = "Subscriber Balance Sheet";
}
<style>
    fieldset {
        padding: 5px;
        border: groove 2px;
        padding-top: 5px;
        margin-bottom: 5px;
        overflow-y: auto;
        height: 180px;
        border-radius: 4px;
        border: 1px solid #ccc;
    }

    .sweet-alert fieldset {
        display: none;
    }

    .sweet-alert p {
        font-weight: 400;
        overflow: auto;
        max-height: 200px;
        white-space: break-spaces;
    }

    a.dropdown-item:hover {
        color: #212529 !important;
    }

</style>
<div class="row">
    <div class="col-md-12">
        <div class="card" style="height: 70px;z-index:1;">
            <form method="post" asp-action="SearchBalanceSheet">
                <div class="form-row">
                    <div class="form-group col-md-4">
                        <select asp-for="IdentifierType" asp-items="Html.GetEnumSelectList<UserIdentifier>()" class="form-control">
                            <option value="">select type</option>
                        </select>
                        <span asp-validation-for="IdentifierType" class="text-danger"></span>
                    </div>
                    <div class="form-group col-md-4">
                        <input asp-for="IdentifierValue" class="form-control " placeholder="Enter Value" />
                        <input type="hidden" id="selectedSubcriber" name="SelectedSubcriber" />
                        <span asp-validation-for="IdentifierValue" class="text-danger"></span>
                    </div>
                    <div>
                        <input type="submit" class="btn btn-primary" value="Search" />
                        &nbsp;&nbsp;
                        <input type="button" class="btn btn-danger" value="Clear" onclick="resetFields()" />
                    </div>
                </div>
            </form>
        </div>

        @if (Model.BalanceSheetDetails != null)
        {
            <div id="balanceSheetDetailsDiv">
                @await Html.PartialAsync("_BalanceSheetDetails", Model.BalanceSheetDetails)
                </div>
        }
    </div>
</div>

@{
    await Html.RenderPartialAsync("_ValidationScriptsPartial");
}

<script src="~/assets/js/bootstrap3-typeahead.min.js" asp-append-version="true"></script>

<script>
    $(document).ready(function () {
            $('#priceModelMenu').addClass('active');
            $('#balanceSheetMenuItem').addClass('active');
            $('#SubscriberBalanceSheetSidebarElement').addClass('active');

            $('#priceModel').addClass('show');
            $('#balanceSheetSubmenu').addClass('show');

            $("li#balanceSheetMenuItem a:first").attr('aria-expanded', 'true');
            $("li#SubscriberBalanceSheetSidebarElement a:first").attr('aria-expanded', 'true');

            /*For Beadcrum Start*/
            $('#homeMenu').addClass('breadcrumb-item').append('Price Model');
            $('#mainMenu').addClass('breadcrumb-item').append('Balance Sheet');
            $('#subMenu').addClass('breadcrumb-item active').append('Subscriber');
            /*For Beadcrum End*/

            $('#IdentifierType').change(function () {
                var identifierValue = $("#IdentifierValue");
                identifierValue.unbind("keypress");
                let placeholderObject = {
                    3: "Email",
                    4: "Mobile Number (+97198XX...)"
                }

                identifierValue.val("");
                $("span[data-valmsg-for='IdentifierValue']").html('');

                if ($("#IdentifierValue").val() == "") {
                    if ($("#IdentifierType").val() != "") {
                        var identifierValueSelected = $("#IdentifierType").val();
                        $("#IdentifierValue").attr("placeholder", "Enter " + placeholderObject[identifierValueSelected.toString()]);
                    }
                    else
                        $("#IdentifierValue").attr("placeholder", "Enter Value");
                    identifierValue.val("");
                }

                if ($('select option:selected').val() == 4) {
                    identifierValue.keypress(function (e) {
                        if (identifierValue.val().length >= 13)
                        {
                            return false;
                        }
                        var charCode = (e.which) ? e.which : event.keyCode;
                        if (String.fromCharCode(charCode).match(/[^+0-9]/g))
                            return false;
                    });
                }
            });

        $("#IdentifierValue").typeahead({
            minLength: 5,
            items: 10,
            source: function (request, response) {
                let type = $('#IdentifierType').val();
                if (type == "")
                    return;

                $.ajax({
                    url: '@Url.Action("GetSubscribers", "SubscriberBalanceSheet")',
                    data: { "type": parseInt(type), "value": request },
                    type: "GET",
                    contentType: "json",
                    error: ajaxErrorHandler,
                    success: function (data) {
                        items = [];
                        map = {};
                        $.each(data, function (i, item) {
                            var id = i;
                            var name = item;
                            map[name] = {
                                id: id,
                                name: name
                            };
                            items.push(name);
                        });
                        response(items);
                    }
                });
            },
            updater: function (item) {
                return item;
            }
        });

            $("input[type='submit']").on("click", function (e) {
                var email = $('#IdentifierValue');
                if ($('select option:selected').val() == 3 && email.val() != '') {
                    var emailRegex = /^([\w-\.]+)@@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.)|(([\w-]+\.)+))([a-zA-Z]{2,4}|[0-9]{1,3})(\]?)$/;
                    if (!emailRegex.test(email.val())) {
                        $("span[data-valmsg-for='IdentifierValue']").html("Invalid email address");
                        e.preventDefault();
                    }
                }
            });

        });

        function resetFields() {
            $('select').val('');
            $("input:text").val("");
            $('#balanceSheetDetailsDiv').empty();
            $('.text-danger').text('');
            $("#IdentifierValue").attr("placeholder", "Enter Value");
        }

</script>